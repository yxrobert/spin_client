Started by user [8mha:////4NL15lwhNok46o8LpNIYOqAIaurwr6Vm2yW5YSW4R5+wAAAAlh+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAyWEgYu/dLi1CL9ovz8EgDKVWzSvwAAAA==[0mroot
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 更新GameServer与配置
[8mha:////4JronOm2HTzVoBykng7Thj/q3dth5IoW4SP8n9ffFPRiAAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGFRNTQ1PjpCQjXeNkczNdkxRjc93ERAtz3WQDE5O0pMREo9SURADoE2+NrwAAAA==[0m[SSH] executing pre build script:
server_name="pkcp"
variable_args="disable_rtp_limit"

#!/bin/bash
source /root/jenkins/jk_func.sh

if [ -z "$server_name" ]; then
    echo "Error: 没有选择服务器!"
    exit 1
fi

file_lock
echo ${server_name}
check_env_args ${server_name}
echo ${variable_args}

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['game']")
server_port=$(yaml $conf_file "['$server_name']['port']")
echo ${branch_name}

# conf
cd /home/user00/cc/cc-slots-land/cc-dev
./auto_upload_config.sh ${server_name} deploy-cc-conf

# run
cd /mnt/slots/cc-server
git cd $branch_name
check_last_cmd $branch_name
git pull
check_last_cmd pull
cd /mnt/slots/cc-slots-land/batch
set_env_args ${variable_args}
./compile.sh $server_name && ./build_image.sh $server_name && ./run_image.sh $server_name $server_port
clear_env_args

file_unlock




脚本可执行
pkcp
disable_rtp_limit
{'bandit': 'develop', 'game': 'feature/spin_max_bonus', 'cc-conf': 'deploy-cc-conf', 'desc': 'pkcp', 'rpc_port': 10009, 'bandit-conf': 'deploy-bandit-conf', 'port': 9999}
feature/spin_max_bonus
[0;31m脚本运行中，请稍后执行！[0m
Switched to branch 'feature/spin_max_bonus'
Already up-to-date.
disable_rtp_limit
disable_rtp_limit
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkcp
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkcp/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkcp_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkcp_dev_bandit
[0;35m           Network:[0m pkcp
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkcp-redis:6379
[0;35m Backend-Container:[0m pkcp-backend
[1;33m  BANDIT-Container:[0m pkcp-rpc
[0;32m Fluentd-Container:[0m pkcp-fluentd
[0;32m   Mongo-Container:[0m pkcp-mongo
[0;32m   Redis-Container:[0m pkcp-redis
[1;33m    BUILD TARGET:[0m game
[1;33m   BUILD COMMAND:[0m cd proto && make server -B && cd .. && server/output/build-server.sh docker
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/cc-server
[1;33m        CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pkcp/config.ini
[1;33mCONFIG_FILE_PROD:[0m pkcp/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "backend-builder"   --hostname "backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/cc-server":"/slots"   -v "/home/user00/cc/cc-conf":"/cc-conf"   -v "/home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd proto && make server -B && cd .. && server/output/build-server.sh docker"[0m
rm ../server/pb/*.pb.go 2>/dev/null || :
protoc --go_out=../server/pb *.proto
[0;32mbuilding "plutus-server"[0m
[0;33mLDFLAGS[0m = [0;36m-X 'plutus/core.BuildGoVersion=go1.17.12 linux/amd64' -X 'plutus/core.BuildTime=2023-03-28T12:25:56+0800' -X 'plutus/core.BuildType=docker' -X 'plutus/core.BuildHost=backend-builder' -X 'plutus/core.BuildGit=feature/spin_max_bonus:3e13215e9-dirty' -X 'plutus/core.BuildConf=v0.0.74-0.20230328020243-3e99dff63ca3'[0m
[0;33mTARGET[0m = [0;36m/slots/server/cmd/main/plutus-server-next[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pkcp/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;32mcopy server config: pkcp/config.ini /home/user00/cc/cc-slots-land/stage/app=pkcp/app/config.ini[0m
[0;32mremove container: backend-builder[0m
[0;36mreclaim resources: backend-builder 64ff1f0c8a44[0m
64ff1f0c8a44
64ff1f0c8a44
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  7.799MBSending build context to Docker daemon   15.6MBSending build context to Docker daemon  22.28MBSending build context to Docker daemon  28.97MBSending build context to Docker daemon  34.54MBSending build context to Docker daemon  40.11MBSending build context to Docker daemon  47.35MBSending build context to Docker daemon  53.48MBSending build context to Docker daemon  62.39MBSending build context to Docker daemon  69.63MBSending build context to Docker daemon  76.32MBSending build context to Docker daemon  85.23MBSending build context to Docker daemon  93.03MBSending build context to Docker daemon  101.9MBSending build context to Docker daemon  107.5MBSending build context to Docker daemon  114.2MBSending build context to Docker daemon  121.4MBSending build context to Docker daemon  128.7MBSending build context to Docker daemon  134.8MBSending build context to Docker daemon  139.8MBSending build context to Docker daemon  148.2MBSending build context to Docker daemon  152.1MBSending build context to Docker daemon  160.4MBSending build context to Docker daemon  168.2MBSending build context to Docker daemon  175.5MBSending build context to Docker daemon  183.3MBSending build context to Docker daemon  190.5MBSending build context to Docker daemon  197.8MBSending build context to Docker daemon  203.3MBSending build context to Docker daemon  212.2MBSending build context to Docker daemon    220MBSending build context to Docker daemon  227.8MBSending build context to Docker daemon  235.6MBSending build context to Docker daemon  242.3MBSending build context to Docker daemon  248.4MBSending build context to Docker daemon    254MBSending build context to Docker daemon  261.3MBSending build context to Docker daemon  266.8MBSending build context to Docker daemon    273MBSending build context to Docker daemon  280.8MBSending build context to Docker daemon  288.6MBSending build context to Docker daemon  296.9MBSending build context to Docker daemon  305.8MBSending build context to Docker daemon  306.6MB
Step 1/5 : FROM alpine:3.12.0
 ---> a24bb4013296
Step 2/5 : ARG app
 ---> Using cache
 ---> 00422b32391e
Step 3/5 : ADD $app/app/ /slots
 ---> 24a2f8ef0c4a
Step 4/5 : WORKDIR /slots
 ---> Running in bd58dc9459e1
Removing intermediate container bd58dc9459e1
 ---> eaf05ce8be59
Step 5/5 : ENTRYPOINT ["/slots/plutus-server"]
 ---> Running in c4b5c616710d
Removing intermediate container c4b5c616710d
 ---> 7c220dc7b35f
Successfully built 7c220dc7b35f
Successfully tagged plutus:pkcp
[0;32mgc: app=pkcp/app/backend[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkcp
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkcp/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkcp_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkcp_dev_bandit
[0;35m           Network:[0m pkcp
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkcp-redis:6379
[0;35m Backend-Container:[0m pkcp-backend
[1;33m  BANDIT-Container:[0m pkcp-rpc
[0;32m Fluentd-Container:[0m pkcp-fluentd
[0;32m   Mongo-Container:[0m pkcp-mongo
[0;32m   Redis-Container:[0m pkcp-redis

[0;32mstart pkcp-backend[0m
[0;36m  docker run -d     -e app=pkcp.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pkcp     -e sys_stage=dev_backend     -e hostname=10.0.84.16     -e port=9999 	--env-file .env     -p 9999:9000 -p 10099:9168     --network pkcp     --name pkcp-backend     plutus:pkcp[0m
[0;36mreclaim resources: pkcp-backend c974ba480d5e[0m
c974ba480d5e
c974ba480d5e
5739d3cfc35b34d565b1c0d4cd848fa5f9b94cd0a6b297741febd4a2ca995e71
[0;32mwaiting for pkcp-backend...[0m
[0;32m=====> try 0 times[0m
curl: (56) Recv failure: Connection reset by peer
[0;32m=====> try 1 times[0m
400 Bad Request2023-03-28 04:28:29.603197 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
{"log_level":"warn","date":"2023-03-28T04:28:29.603Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cgh6prc2845cb5dotpvg","server_id":"cgh6prc2845cb5dotptg","server_ip":"172.21.0.6","server_birth":1679977709,"host_name":"5739d3cfc35b","glog-msg":"[sandwich] [deprecated] should use WithAdapter to initialize pmconf package."}
{"log_level":"warn","date":"2023-03-28T04:28:29.620Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cgh6prc2845cb5dotq00","server_id":"cgh6prc2845cb5dotptg","server_ip":"172.21.0.6","server_birth":1679977709,"host_name":"5739d3cfc35b","glog-msg":"[sandwich] [deprecated] PmConfPath changed due to sys_env_name and sys_stage, should use sandwich_conf_env","sysConfEnvStaging":"pkcp_dev_backend","pm_conf_path":"/pkcp_dev_backend"}
{
	"logger": {
		"timelocation": {},
		"host": "pkcp-fluentd",
		"type": "logbus",
		"serverbirth": "2023-03-28T00:28:30-04:00",
		"port": 24224,
		"withcaller": false
	},
	"timelocation": {},
	"gmt": {
		"listen": "0.0.0.0:9000",
		"secret": "xkcs;wjngSDGJL;KADlkafas"
	},
	"httplistenaddr": "0.0.0.0:9000",
	"serverbirth": "2023-03-28T00:28:30-04:00",
	"serveropen": "2021-01-01T00:00:00Z",
	"lighthouse": {
		"token": "c3p0zmycr83g00066h6g"
	},
	"app": "pkcp.dev",
	"funplus": {
		"url": "https://passport-sandbox-checksession.centurygame.com/server_api.php",
		"paysecret": "o+gt#+v)@-0\u002609my@e0@1c9v\u0026629i02t(kd9ry_sw\u0026j*oi*l4)",
		"serverpayid": "not-support",
		"expire": 3600
	},
	"bi": {
		"host": "",
		"mark": "178_pkcp",
		"port": 24224
	},
	"sisyphus": {
		"listen": "0.0.0.0:9000",
		"collection": "idGen",
		"timeout": 10000000000,
		"section": 0
	},
	"postoffice": {
		"listen": "0.0.0.0:9000",
		"serviceurl": "http://pkcp-postOffice:9000",
		"router": "/push",
		"reqpushurl": "",
		"appkey": "ca176bf86c3300375acebc07ff6684b0",
		"interval": 10,
		"timeout": 30000000000,
		"appid": 20106,
		"workercount": 20
	},
	"redis": {
		"uri": "pkcp-redis:6379",
		"pwd": "",
		"db": 0,
		"timeout": 5000000000,
		"usecluster": false
	},
	"rtm": {
		"servergateurl": "",
		"secretkey": "",
		"connecttimeout": 0,
		"questtimeout": 0,
		"adminuid": 0,
		"projectid": 0,
		"autoreconnect": false,
		"enable": false
	},
	"mongo": {
		"uri": "mongodb://root:passwd@pkcp-mongo:27017/?authSource=admin",
		"db": "plutus",
		"connecttimeout": 2000000000,
		"questtimeout": 10000000000,
		"deferduration": 60000000000,
		"lifetime": 3600000000000
	},
	"inbox": {
		"timeout": 10000000000
	},
	"dev": {
		"mode": true,
		"usegops": false,
		"richnewplayer": false
	},
	"gateway": {
		"useentitycache": false
	},
	"canonical": false
}
2023-03-28T04:28:31.315Z	[34minfo[0m	buslogger/logger.go:121	server	{"tags": ["logbus"], "log_xid": "cgh6prs2845cb5dotq0g", "server_ip": "172.21.0.6", "host_name": "5739d3cfc35b", "server_id": "f3d1100b-d74e-4a18-9280-5131c41325a9", "server_birth": 1679977710, "role": "bootstrap", "msg": "TimeFake: add: 21853559, now: 2023-12-05 21:54:30.315279083 -0500 EST"}
2023-03-28T04:28:31.384Z	[34minfo[0m	sandwich@v1.2.85/endpoint.go:269	server	{"tags": ["logbus"], "log_xid": "cgh6prs2845cb5dotq20", "server_ip": "172.21.0.6", "host_name": "5739d3cfc35b", "server_id": "f3d1100b-d74e-4a18-9280-5131c41325a9", "server_birth": 1679977710, "glog-msg": "[sandwich] sandwich endpoint update summary", "registry_path": "/pkcp.dev/sandwich/service/slot/", "entries": ["cggo5v428454nbuautqg_172.21.0.5:8087"], "added": ["cggo5v428454nbuautqg_172.21.0.5:8087"], "keys_removed": [], "keys_now": ["cggo5v428454nbuautqg"], "keys_old": []}
2023-03-28T04:28:38.341Z	[34minfo[0m	buslogger/logger.go:101	server	{"tags": ["logbus"], "log_xid": "cgh6ptk2845cb5dotq30", "server_ip": "172.21.0.6", "host_name": "5739d3cfc35b", "server_id": "f3d1100b-d74e-4a18-9280-5131c41325a9", "server_birth": 1679977710, "role": "server", "msg": "game server start..."}
2023-03-28T04:28:38.636Z	[35mdebug[0m	ark@v1.2.2/ark.go:394	server	{"tags": ["logbus"], "log_xid": "cgh6ptk2845cb5dotq40", "server_ip": "172.21.0.6", "host_name": "5739d3cfc35b", "server_id": "f3d1100b-d74e-4a18-9280-5131c41325a9", "server_birth": 1679977710, "glog-msg": "[ark]Listening and serving HTTP on listener 0.0.0.0:9000"}

[0;32mpkcp-backend ready[0m
[1;33mversion:[0m [0;32m{"Git":"feature/spin_max_bonus:3e13215e9-dirty", "BuildTime":"2023-03-28T12:25:56+0800", "BuildHost":"backend-builder", "Type":"docker", "Go":"go1.17.12 linux/amd64", "Conf":"v0.0.74-0.20230328020243-3e99dff63ca3", "Branch":""}[0m
CONTAINER ID   IMAGE         COMMAND                  CREATED          STATUS         PORTS                                             NAMES
5739d3cfc35b   plutus:pkcp   "/slots/plutus-server"   10 seconds ago   Up 9 seconds   0.0.0.0:9999->9000/tcp, 0.0.0.0:10099->9168/tcp   pkcp-backend
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pkcp"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E6%9B%B4%E6%96%B0GameServer%E4%B8%8E%E9%85%8D%E7%BD%AE/1/"

source /root/jenkins/jk_func.sh
~/jenkins/analyze_log/analyze_err -url ${BUILD_URL}
sleep 5
check_whole_server $server_name

任务错误报告: http://10.0.84.16:8083/job/服务器 - 更新GameServer与配置/1/
路径: /var/lib/docker/volumes/jenkins-data/_data/jobs/服务器 - 更新GameServer与配置/builds/1/log

问题 : [有其他人正在执行任务, 或者上一次的任务未能正确执行]
解决方法 : [使用{分支 - 尝试解决重启失败}, 解决问题后, 重新执行]
错误内容 : [
		feature/spin_max_bonus
		[0;31m脚本运行中，请稍后执行！[0m
]

pkcp-backend Check
pkcp-rpc Check
pkcp-redis Check
pkcp-mongo Check
pkcp-fluentd Check

[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
