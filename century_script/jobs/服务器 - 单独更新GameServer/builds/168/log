Started by user [8mha:////4NL15lwhNok46o8LpNIYOqAIaurwr6Vm2yW5YSW4R5+wAAAAlh+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAyWEgYu/dLi1CL9ovz8EgDKVWzSvwAAAA==[0mroot
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 单独更新GameServer
[8mha:////4D0glr8lOtkS2xfFGocY2umCdU82qXTtOqUP2pHV8GS7AAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGFQOTZJNUcwsDXZNUC2NdE9OURN1EExNj3bRkM5M0U1MTQ8OkVACZl3unrwAAAA==[0m[SSH] executing pre build script:
server_name="pk7017"
variable_args="disable_rtp_limit"

#!/bin/bash
source /root/jenkins/jk_func.sh

if [ -z "$server_name" ]; then
    echo "Error: 没有选择服务器!"
    exit 1
fi

file_lock
echo ${server_name}
check_env_args ${server_name}
echo ${variable_args}

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['game']")
server_port=$(yaml $conf_file "['$server_name']['port']")
echo ${branch_name}

# run
cd /mnt/slots/cc-server
git cd $branch_name
check_last_cmd $branch_name
git pull
check_last_cmd pull
cd /mnt/slots/cc-slots-land/batch
set_env_args ${variable_args}
./compile.sh $server_name && ./build_image.sh $server_name && ./run_image.sh $server_name $server_port
clear_env_args

file_unlock




脚本可执行
pk7017
disable_rtp_limit
{'bandit': 'develop', 'game': 'feature/journey_booster_pr6', 'cc-conf': 'deploy-cc-conf', 'desc': 'pk7017', 'rpc_port': 7117, 'bandit-conf': 'deploy-bandit-conf', 'port': 7207}
feature/journey_booster_pr6
Already on 'feature/journey_booster_pr6'
remote: Enumerating objects: 8, done.[K
remote: Counting objects:  12% (1/8)[Kremote: Counting objects:  25% (2/8)[Kremote: Counting objects:  37% (3/8)[Kremote: Counting objects:  50% (4/8)[Kremote: Counting objects:  62% (5/8)[Kremote: Counting objects:  75% (6/8)[Kremote: Counting objects:  87% (7/8)[Kremote: Counting objects: 100% (8/8)[Kremote: Counting objects: 100% (8/8), done.[K
remote: Compressing objects:  12% (1/8)[Kremote: Compressing objects:  25% (2/8)[Kremote: Compressing objects:  37% (3/8)[Kremote: Compressing objects:  50% (4/8)[Kremote: Compressing objects:  62% (5/8)[Kremote: Compressing objects:  75% (6/8)[Kremote: Compressing objects:  87% (7/8)[Kremote: Compressing objects: 100% (8/8)[Kremote: Compressing objects: 100% (8/8), done.[K
remote: Total 8 (delta 0), reused 0 (delta 0), pack-reused 0[K
Unpacking objects:  12% (1/8)   Unpacking objects:  25% (2/8)   Unpacking objects:  37% (3/8)   Unpacking objects:  50% (4/8)   Unpacking objects:  62% (5/8)   Unpacking objects:  75% (6/8)   Unpacking objects:  87% (7/8)   Unpacking objects: 100% (8/8)   Unpacking objects: 100% (8/8), done.
From gitlab.funplus.io:cheesecake/cc-server
   d5ead3f..25f8759  feature/journey_booster_pr6 -> origin/feature/journey_booster_pr6
Updating d5ead3f..25f8759
Fast-forward
 .../activity/iactivity/journey/assembler.go        | 30 [32m+++++++[m[31m---------------[m
 1 file changed, 9 insertions(+), 21 deletions(-)
disable_rtp_limit
disable_rtp_limit
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7017
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7017/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7017/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7017/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7017/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7017_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7017_dev_bandit
[0;35m           Network:[0m pk7017
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7017-redis:6379
[0;35m Backend-Container:[0m pk7017-backend
[1;33m  BANDIT-Container:[0m pk7017-rpc
[0;32m Fluentd-Container:[0m pk7017-fluentd
[0;32m   Mongo-Container:[0m pk7017-mongo
[0;32m   Redis-Container:[0m pk7017-redis
[1;33m    BUILD TARGET:[0m game
[1;33m   BUILD COMMAND:[0m cd proto && make server -B && cd .. && server/output/build-server.sh docker
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/cc-server
[1;33m        CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pk7017/config.ini
[1;33mCONFIG_FILE_PROD:[0m pk7017/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "backend-builder"   --hostname "backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/cc-server":"/slots"   -v "/home/user00/cc/cc-conf":"/cc-conf"   -v "/home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd proto && make server -B && cd .. && server/output/build-server.sh docker"[0m
rm ../server/pb/*.pb.go 2>/dev/null || :
protoc --go_out=../server/pb *.proto
[0;32mbuilding "plutus-server"[0m
[0;33mLDFLAGS[0m = [0;36m-X 'plutus/core.BuildGoVersion=go1.17.12 linux/amd64' -X 'plutus/core.BuildTime=2023-03-28T15:38:17+0800' -X 'plutus/core.BuildType=docker' -X 'plutus/core.BuildHost=backend-builder' -X 'plutus/core.BuildGit=feature/journey_booster_pr6:25f87598f-dirty' -X 'plutus/core.BuildConf=v0.0.74-0.20230328070123-abaec494ee43'[0m
[0;33mTARGET[0m = [0;36m/slots/server/cmd/main/plutus-server-next[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pk7017/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;32mcopy server config: pk7017/config.ini /home/user00/cc/cc-slots-land/stage/app=pk7017/app/config.ini[0m
[0;32mremove container: backend-builder[0m
[0;36mreclaim resources: backend-builder 7a35d94d0adf[0m
7a35d94d0adf
7a35d94d0adf
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  8.913MBSending build context to Docker daemon  16.71MBSending build context to Docker daemon  23.95MBSending build context to Docker daemon  31.75MBSending build context to Docker daemon  40.11MBSending build context to Docker daemon  47.35MBSending build context to Docker daemon  52.36MBSending build context to Docker daemon   59.6MBSending build context to Docker daemon  66.85MBSending build context to Docker daemon  74.65MBSending build context to Docker daemon     83MBSending build context to Docker daemon  91.36MBSending build context to Docker daemon  99.16MBSending build context to Docker daemon  105.3MBSending build context to Docker daemon  113.6MBSending build context to Docker daemon  121.4MBSending build context to Docker daemon    127MBSending build context to Docker daemon  134.3MBSending build context to Docker daemon  140.9MBSending build context to Docker daemon  148.7MBSending build context to Docker daemon  156.5MBSending build context to Docker daemon    161MBSending build context to Docker daemon  168.8MBSending build context to Docker daemon    176MBSending build context to Docker daemon  183.8MBSending build context to Docker daemon  191.6MBSending build context to Docker daemon  199.4MBSending build context to Docker daemon  206.7MBSending build context to Docker daemon  214.5MBSending build context to Docker daemon  222.3MBSending build context to Docker daemon  229.5MBSending build context to Docker daemon  236.7MBSending build context to Docker daemon  242.9MBSending build context to Docker daemon  250.7MBSending build context to Docker daemon  258.5MBSending build context to Docker daemon  266.3MBSending build context to Docker daemon  273.5MBSending build context to Docker daemon  280.2MBSending build context to Docker daemon    288MBSending build context to Docker daemon  295.2MBSending build context to Docker daemon    303MBSending build context to Docker daemon  306.8MB
Step 1/5 : FROM alpine:3.12.0
 ---> a24bb4013296
Step 2/5 : ARG app
 ---> Using cache
 ---> 00422b32391e
Step 3/5 : ADD $app/app/ /slots
 ---> acf9529a9127
Step 4/5 : WORKDIR /slots
 ---> Running in a60c272805dc
Removing intermediate container a60c272805dc
 ---> 2508e0ea0e7c
Step 5/5 : ENTRYPOINT ["/slots/plutus-server"]
 ---> Running in f335e447444d
Removing intermediate container f335e447444d
 ---> 2c4ef2d1f2a7
Successfully built 2c4ef2d1f2a7
Successfully tagged plutus:pk7017
[0;32mgc: app=pk7017/app/backend[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7017
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7017/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7017/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7017/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7017/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7017_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7017_dev_bandit
[0;35m           Network:[0m pk7017
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7017-redis:6379
[0;35m Backend-Container:[0m pk7017-backend
[1;33m  BANDIT-Container:[0m pk7017-rpc
[0;32m Fluentd-Container:[0m pk7017-fluentd
[0;32m   Mongo-Container:[0m pk7017-mongo
[0;32m   Redis-Container:[0m pk7017-redis

[0;32mstart pk7017-backend[0m
[0;36m  docker run -d     -e app=pk7017.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pk7017     -e sys_stage=dev_backend     -e hostname=10.0.84.16     -e port=7207 	--env-file .env     -p 7207:9000 -p 7307:9168     --network pk7017     --name pk7017-backend     plutus:pk7017[0m
[0;36mreclaim resources: pk7017-backend cc04b8719cdc[0m
cc04b8719cdc
cc04b8719cdc
0bfec29e059e2fe4e2aa69417aaca455c0a1156338d0a5059a188dc1887208ba
[0;32mwaiting for pk7017-backend...[0m
[0;32m=====> try 0 times[0m
curl: (56) Recv failure: Connection reset by peer
[0;32m=====> try 1 times[0m
400 Bad Request2023-03-28 07:40:49.390398 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
{"log_level":"warn","date":"2023-03-28T07:40:49.390Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cgh9k0c284582q7bgb30","server_id":"cgh9k0c284582q7bgb10","server_ip":"192.168.128.6","server_birth":1679989249,"host_name":"0bfec29e059e","glog-msg":"[sandwich] [deprecated] should use WithAdapter to initialize pmconf package."}
{"log_level":"warn","date":"2023-03-28T07:40:49.400Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cgh9k0c284582q7bgb3g","server_id":"cgh9k0c284582q7bgb10","server_ip":"192.168.128.6","server_birth":1679989249,"host_name":"0bfec29e059e","glog-msg":"[sandwich] [deprecated] PmConfPath changed due to sys_env_name and sys_stage, should use sandwich_conf_env","sysConfEnvStaging":"pk7017_dev_backend","pm_conf_path":"/pk7017_dev_backend"}
{
	"logger": {
		"timelocation": {},
		"host": "pk7017-fluentd",
		"type": "logbus",
		"serverbirth": "2023-03-28T03:40:50-04:00",
		"port": 24224,
		"withcaller": false
	},
	"timelocation": {},
	"gmt": {
		"listen": "0.0.0.0:9000",
		"secret": "xkcs;wjngSDGJL;KADlkafas"
	},
	"httplistenaddr": "0.0.0.0:9000",
	"serverbirth": "2023-03-28T03:40:50-04:00",
	"serveropen": "2021-01-01T00:00:00Z",
	"lighthouse": {
		"token": "c3p0zmycr83g00066h6g"
	},
	"app": "pk7017.dev",
	"funplus": {
		"url": "https://passport-sandbox-checksession.centurygame.com/server_api.php",
		"paysecret": "o+gt#+v)@-0\u002609my@e0@1c9v\u0026629i02t(kd9ry_sw\u0026j*oi*l4)",
		"serverpayid": "not-support",
		"expire": 3600
	},
	"bi": {
		"host": "",
		"mark": "178_pk7017",
		"port": 24224
	},
	"sisyphus": {
		"listen": "0.0.0.0:9000",
		"collection": "idGen",
		"timeout": 10000000000,
		"section": 0
	},
	"postoffice": {
		"listen": "0.0.0.0:9000",
		"serviceurl": "http://pk7017-postOffice:9000",
		"router": "/push",
		"reqpushurl": "",
		"appkey": "ca176bf86c3300375acebc07ff6684b0",
		"interval": 10,
		"timeout": 30000000000,
		"appid": 20106,
		"workercount": 20
	},
	"redis": {
		"uri": "pk7017-redis:6379",
		"pwd": "",
		"db": 0,
		"timeout": 5000000000,
		"usecluster": false
	},
	"rtm": {
		"servergateurl": "",
		"secretkey": "",
		"connecttimeout": 0,
		"questtimeout": 0,
		"adminuid": 0,
		"projectid": 0,
		"autoreconnect": false,
		"enable": false
	},
	"mongo": {
		"uri": "mongodb://root:passwd@pk7017-mongo:27017/?authSource=admin",
		"db": "plutus",
		"connecttimeout": 2000000000,
		"questtimeout": 10000000000,
		"deferduration": 60000000000,
		"lifetime": 3600000000000
	},
	"inbox": {
		"timeout": 10000000000
	},
	"dev": {
		"mode": true,
		"usegops": false,
		"richnewplayer": false
	},
	"gateway": {
		"useentitycache": false
	},
	"canonical": false
}
2023-03-28T07:40:50.845Z	[34minfo[0m	buslogger/logger.go:121	server	{"tags": ["logbus"], "log_xid": "cgh9k0k284582q7bgb40", "server_ip": "192.168.128.6", "host_name": "0bfec29e059e", "server_id": "9038614a-5a10-491a-bf37-a06c46e8387e", "server_birth": 1679989250, "role": "bootstrap", "msg": "TimeFake: add: 9595323, now: 2023-07-17 05:02:53.845527596 -0400 EDT"}
2023-03-28T07:40:50.941Z	[34minfo[0m	sandwich@v1.2.85/endpoint.go:269	server	{"tags": ["logbus"], "log_xid": "cgh9k0k284582q7bgb5g", "server_ip": "192.168.128.6", "host_name": "0bfec29e059e", "server_id": "9038614a-5a10-491a-bf37-a06c46e8387e", "server_birth": 1679989250, "glog-msg": "[sandwich] sandwich endpoint update summary", "registry_path": "/pk7017.dev/sandwich/service/slot/", "entries": ["cgehlgs28451fuos8of0_192.168.128.5:8087"], "added": ["cgehlgs28451fuos8of0_192.168.128.5:8087"], "keys_removed": [], "keys_now": ["cgehlgs28451fuos8of0"], "keys_old": []}
2023-03-28T07:40:57.617Z	[34minfo[0m	buslogger/logger.go:101	server	{"tags": ["logbus"], "log_xid": "cgh9k2c284582q7bgb6g", "server_ip": "192.168.128.6", "host_name": "0bfec29e059e", "server_id": "9038614a-5a10-491a-bf37-a06c46e8387e", "server_birth": 1679989250, "role": "server", "msg": "game server start..."}
2023-03-28T07:40:57.884Z	[35mdebug[0m	ark@v1.2.2/ark.go:394	server	{"tags": ["logbus"], "log_xid": "cgh9k2c284582q7bgb7g", "server_ip": "192.168.128.6", "host_name": "0bfec29e059e", "server_id": "9038614a-5a10-491a-bf37-a06c46e8387e", "server_birth": 1679989250, "glog-msg": "[ark]Listening and serving HTTP on listener 0.0.0.0:9000"}
2023-03-28T07:40:57.927Z	[34minfo[0m	server/gateway.go:221	request	{"tags": ["gateway"], "SessionID": "100000000000301_71e5883f-3474-47cb-a9fd-272557f735be", "mainVer": "0.13", "os": "and", "log_xid": "cgh9k2c284582q7bgb8g", "server_ip": "192.168.128.6", "host_name": "0bfec29e059e", "server_id": "9038614a-5a10-491a-bf37-a06c46e8387e", "server_birth": 1679989250, "protocol": {"🔺 ": "SID:10 Multi:{Auth:{PlayerID:100000000000301 Token:\"71e5883f-3474-47cb-a9fd-272557f735be\"} Requests:{Step:56 Shop:{ProductList:{Situations:LegendJourneyBuff SRC:11}}}}"}}

[0;32mpk7017-backend ready[0m
[1;33mversion:[0m [0;32m{"Git":"feature/journey_booster_pr6:25f87598f-dirty","BuildTime":"2023-03-28T15:38:17+0800","BuildHost":"backend-builder","Type":"docker","Go":"go1.17.12 linux/amd64","Conf":"v0.0.74-0.20230328070123-abaec494ee43","Branch":""}[0m
CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS         PORTS                                            NAMES
0bfec29e059e   plutus:pk7017   "/slots/plutus-server"   10 seconds ago   Up 8 seconds   0.0.0.0:7207->9000/tcp, 0.0.0.0:7307->9168/tcp   pk7017-backend
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pk7017"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E5%8D%95%E7%8B%AC%E6%9B%B4%E6%96%B0GameServer/168/"

source /root/jenkins/jk_func.sh
~/jenkins/analyze_log/analyze_err -url ${BUILD_URL}
sleep 5
check_whole_server $server_name

pk7017-backend Check
pk7017-rpc Check
pk7017-redis Check
pk7017-mongo Check
pk7017-fluentd Check

[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
