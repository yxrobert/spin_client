Started by user [8mha:////4NL15lwhNok46o8LpNIYOqAIaurwr6Vm2yW5YSW4R5+wAAAAlh+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAyWEgYu/dLi1CL9ovz8EgDKVWzSvwAAAA==[0mroot
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 单独更新GameServer
[8mha:////4FL+fpTfcvKk3Fyavc1WV6BawcvN4hTxjtutaRKAsNvRAAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGlWRLY3PLFJMUXZNUgzRdExOLNF2LxLREXTNDS0szy1STVDNjIwCXxcmwrwAAAA==[0m[SSH] executing pre build script:
server_name="pkreview"
variable_args="disable_rtp_limit"

#!/bin/bash
source /root/jenkins/jk_func.sh

if [ -z "$server_name" ]; then
    echo "Error: 没有选择服务器!"
    exit 1
fi

file_lock
echo ${server_name}
check_env_args ${server_name}
echo ${variable_args}

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['game']")
server_port=$(yaml $conf_file "['$server_name']['port']")
echo ${branch_name}

# run
cd /mnt/slots/cc-server
git cd $branch_name
check_last_cmd $branch_name
git pull
check_last_cmd pull
cd /mnt/slots/cc-slots-land/batch
set_env_args ${variable_args}
./compile.sh $server_name && ./build_image.sh $server_name && ./run_image.sh $server_name $server_port
clear_env_args

file_unlock




脚本可执行
pkreview
pkreview force ignore disable_rtp_limit

{'bandit': 'pre/v0.13.7', 'game': 'pre/v0.13.7', 'cc-conf': 'pre/v0.13.7', 'desc': 'pkreview', 'rpc_port': 4454, 'bandit-conf': 'pre/v0.13.7', 'port': 4444}
pre/v0.13.7
Switched to branch 'pre/v0.13.7'
remote: Enumerating objects: 1, done.[K
remote: Counting objects: 100% (1/1)[Kremote: Counting objects: 100% (1/1), done.[K
remote: Total 1 (delta 0), reused 0 (delta 0), pack-reused 0[K
Unpacking objects: 100% (1/1)   Unpacking objects: 100% (1/1), done.
From gitlab.funplus.io:cheesecake/cc-server
   30157ea..49ad1d9  pre/v0.13.7 -> origin/pre/v0.13.7
Updating 30157ea..49ad1d9
Fast-forward
 server/decision/worker/rtp.go | 28 [32m+++++++++++++++++++[m[31m---------[m
 1 file changed, 19 insertions(+), 9 deletions(-)

[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkreview
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkreview/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkreview/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkreview/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkreview/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkreview_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkreview_dev_bandit
[0;35m           Network:[0m pkreview
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkreview-redis:6379
[0;35m Backend-Container:[0m pkreview-backend
[1;33m  BANDIT-Container:[0m pkreview-rpc
[0;32m Fluentd-Container:[0m pkreview-fluentd
[0;32m   Mongo-Container:[0m pkreview-mongo
[0;32m   Redis-Container:[0m pkreview-redis
[1;33m    BUILD TARGET:[0m game
[1;33m   BUILD COMMAND:[0m cd proto && make server -B && cd .. && server/output/build-server.sh docker
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/cc-server
[1;33m        CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pkreview/config.ini
[1;33mCONFIG_FILE_PROD:[0m pkreview/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "backend-builder"   --hostname "backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/cc-server":"/slots"   -v "/home/user00/cc/cc-conf":"/cc-conf"   -v "/home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd proto && make server -B && cd .. && server/output/build-server.sh docker"[0m
rm ../server/pb/*.pb.go 2>/dev/null || :
protoc --go_out=../server/pb *.proto
[0;32mbuilding "plutus-server"[0m
[0;33mLDFLAGS[0m = [0;36m-X 'plutus/core.BuildGoVersion=go1.17.12 linux/amd64' -X 'plutus/core.BuildTime=2023-03-28T16:26:34+0800' -X 'plutus/core.BuildType=docker' -X 'plutus/core.BuildHost=backend-builder' -X 'plutus/core.BuildGit=pre/v0.13.7:49ad1d9c4-dirty' -X 'plutus/core.BuildConf=v0.0.72'[0m
[0;33mTARGET[0m = [0;36m/slots/server/cmd/main/plutus-server-next[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pkreview/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;32mcopy server config: pkreview/config.ini /home/user00/cc/cc-slots-land/stage/app=pkreview/app/config.ini[0m
[0;32mremove container: backend-builder[0m
[0;36mreclaim resources: backend-builder 1779c8591803[0m
1779c8591803
1779c8591803
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  8.913MBSending build context to Docker daemon  16.71MBSending build context to Docker daemon  22.28MBSending build context to Docker daemon  30.08MBSending build context to Docker daemon  38.44MBSending build context to Docker daemon  46.24MBSending build context to Docker daemon  53.48MBSending build context to Docker daemon  61.28MBSending build context to Docker daemon  69.63MBSending build context to Docker daemon  74.65MBSending build context to Docker daemon  81.89MBSending build context to Docker daemon  88.57MBSending build context to Docker daemon  95.26MBSending build context to Docker daemon  103.1MBSending build context to Docker daemon  108.6MBSending build context to Docker daemon  115.9MBSending build context to Docker daemon  123.7MBSending build context to Docker daemon  130.4MBSending build context to Docker daemon  135.9MBSending build context to Docker daemon    137MBSending build context to Docker daemon  138.7MBSending build context to Docker daemon  139.3MBSending build context to Docker daemon  145.4MBSending build context to Docker daemon  153.7MBSending build context to Docker daemon  160.4MBSending build context to Docker daemon  168.8MBSending build context to Docker daemon    176MBSending build context to Docker daemon  183.3MBSending build context to Docker daemon  190.5MBSending build context to Docker daemon  198.9MBSending build context to Docker daemon  207.2MBSending build context to Docker daemon    215MBSending build context to Docker daemon  222.8MBSending build context to Docker daemon  231.2MBSending build context to Docker daemon  239.5MBSending build context to Docker daemon  247.3MBSending build context to Docker daemon    254MBSending build context to Docker daemon  261.3MBSending build context to Docker daemon  268.5MBSending build context to Docker daemon  276.3MBSending build context to Docker daemon  284.7MBSending build context to Docker daemon  291.3MBSending build context to Docker daemon  299.1MBSending build context to Docker daemon  305.3MBSending build context to Docker daemon  306.5MB
Step 1/5 : FROM alpine:3.12.0
 ---> a24bb4013296
Step 2/5 : ARG app
 ---> Using cache
 ---> 00422b32391e
Step 3/5 : ADD $app/app/ /slots
 ---> cb20bff84ce3
Step 4/5 : WORKDIR /slots
 ---> Running in bf4c0601d23d
Removing intermediate container bf4c0601d23d
 ---> 94cade91c599
Step 5/5 : ENTRYPOINT ["/slots/plutus-server"]
 ---> Running in 85dbaaa8dbe2
Removing intermediate container 85dbaaa8dbe2
 ---> 099d9bd5191f
Successfully built 099d9bd5191f
Successfully tagged plutus:pkreview
[0;32mgc: app=pkreview/app/backend[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkreview
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkreview/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkreview/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkreview/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkreview/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkreview_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkreview_dev_bandit
[0;35m           Network:[0m pkreview
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkreview-redis:6379
[0;35m Backend-Container:[0m pkreview-backend
[1;33m  BANDIT-Container:[0m pkreview-rpc
[0;32m Fluentd-Container:[0m pkreview-fluentd
[0;32m   Mongo-Container:[0m pkreview-mongo
[0;32m   Redis-Container:[0m pkreview-redis

[0;32mstart pkreview-backend[0m
[0;36m  docker run -d     -e app=pkreview.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pkreview     -e sys_stage=dev_backend     -e hostname=10.0.84.16     -e port=4444 	--env-file .env     -p 4444:9000 -p 4544:9168     --network pkreview     --name pkreview-backend     plutus:pkreview[0m
[0;36mreclaim resources: pkreview-backend c015f6a626c7[0m
c015f6a626c7
c015f6a626c7
5c9f106c43e4cc8b5ff1b9c747bf0fc2b79f5c8adfa62bbfdf975ffb08583281
[0;32mwaiting for pkreview-backend...[0m
[0;32m=====> try 0 times[0m
curl: (56) Recv failure: Connection reset by peer
[0;32m=====> try 1 times[0m
400 Bad Request2023-03-28 08:29:07.406432 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
{"log_level":"warn","date":"2023-03-28T08:29:07.406Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cghaaks2845ccpqhaae0","server_id":"cghaaks2845ccpqhaac0","server_ip":"172.25.0.6","server_birth":1679992147,"host_name":"5c9f106c43e4","glog-msg":"[sandwich] [deprecated] should use WithAdapter to initialize pmconf package."}
{"log_level":"warn","date":"2023-03-28T08:29:07.417Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cghaaks2845ccpqhaaeg","server_id":"cghaaks2845ccpqhaac0","server_ip":"172.25.0.6","server_birth":1679992147,"host_name":"5c9f106c43e4","glog-msg":"[sandwich] [deprecated] PmConfPath changed due to sys_env_name and sys_stage, should use sandwich_conf_env","sysConfEnvStaging":"pkreview_dev_backend","pm_conf_path":"/pkreview_dev_backend"}
{
	"logger": {
		"timelocation": {},
		"host": "pkreview-fluentd",
		"type": "logbus",
		"serverbirth": "2023-03-28T04:29:08-04:00",
		"port": 24224,
		"withcaller": false
	},
	"timelocation": {},
	"gmt": {
		"listen": "0.0.0.0:9000",
		"secret": "xkcs;wjngSDGJL;KADlkafas"
	},
	"httplistenaddr": "0.0.0.0:9000",
	"serverbirth": "2023-03-28T04:29:08-04:00",
	"serveropen": "2021-01-01T00:00:00Z",
	"lighthouse": {
		"token": "c3p0zmycr83g00066h6g"
	},
	"app": "pkreview.dev",
	"funplus": {
		"url": "https://passport-sandbox-checksession.centurygame.com/server_api.php",
		"paysecret": "o+gt#+v)@-0\u002609my@e0@1c9v\u0026629i02t(kd9ry_sw\u0026j*oi*l4)",
		"serverpayid": "not-support",
		"expire": 3600
	},
	"bi": {
		"host": "",
		"mark": "178_pkreview",
		"port": 24224
	},
	"sisyphus": {
		"listen": "0.0.0.0:9000",
		"collection": "idGen",
		"timeout": 10000000000,
		"section": 0
	},
	"postoffice": {
		"listen": "0.0.0.0:9000",
		"serviceurl": "http://pkreview-postOffice:9000",
		"router": "/push",
		"reqpushurl": "",
		"appkey": "ca176bf86c3300375acebc07ff6684b0",
		"interval": 10,
		"timeout": 30000000000,
		"appid": 20106,
		"workercount": 20
	},
	"redis": {
		"uri": "pkreview-redis:6379",
		"pwd": "",
		"db": 0,
		"timeout": 5000000000,
		"usecluster": false
	},
	"rtm": {
		"servergateurl": "",
		"secretkey": "",
		"connecttimeout": 0,
		"questtimeout": 0,
		"adminuid": 0,
		"projectid": 0,
		"autoreconnect": false,
		"enable": false
	},
	"mongo": {
		"uri": "mongodb://root:passwd@pkreview-mongo:27017/?authSource=admin",
		"db": "plutus",
		"connecttimeout": 2000000000,
		"questtimeout": 10000000000,
		"deferduration": 60000000000,
		"lifetime": 3600000000000
	},
	"inbox": {
		"timeout": 10000000000
	},
	"dev": {
		"mode": true,
		"usegops": false,
		"richnewplayer": false
	},
	"gateway": {
		"useentitycache": false
	},
	"canonical": true
}
2023-03-28T08:29:09.145Z	[34minfo[0m	buslogger/logger.go:121	server	{"tags": ["logbus"], "log_xid": "cghaalc2845ccpqhaaf0", "server_ip": "172.25.0.6", "host_name": "5c9f106c43e4", "server_id": "3aafd81f-468e-4d1c-a102-0316b617821d", "server_birth": 1679992148, "role": "bootstrap", "msg": "TimeFake: add: 116923, now: 2023-03-29 12:57:52.144987126 -0400 EDT"}
2023-03-28T08:29:09.230Z	[34minfo[0m	sandwich@v1.2.85/endpoint.go:269	server	{"tags": ["logbus"], "log_xid": "cghaalc2845ccpqhaagg", "server_ip": "172.25.0.6", "host_name": "5c9f106c43e4", "server_id": "3aafd81f-468e-4d1c-a102-0316b617821d", "server_birth": 1679992148, "glog-msg": "[sandwich] sandwich endpoint update summary", "registry_path": "/pkreview.dev/sandwich/service/slot/", "entries": ["cggl3as2845e1fugunqg_172.25.0.5:8087"], "added": ["cggl3as2845e1fugunqg_172.25.0.5:8087"], "keys_removed": [], "keys_now": ["cggl3as2845e1fugunqg"], "keys_old": []}
2023-03-28T08:29:16.202Z	[34minfo[0m	buslogger/logger.go:101	server	{"tags": ["logbus"], "log_xid": "cghaan42845ccpqhaahg", "server_ip": "172.25.0.6", "host_name": "5c9f106c43e4", "server_id": "3aafd81f-468e-4d1c-a102-0316b617821d", "server_birth": 1679992148, "role": "server", "msg": "game server start..."}
2023-03-28T08:29:16.486Z	[35mdebug[0m	ark@v1.2.2/ark.go:394	server	{"tags": ["logbus"], "log_xid": "cghaan42845ccpqhaaig", "server_ip": "172.25.0.6", "host_name": "5c9f106c43e4", "server_id": "3aafd81f-468e-4d1c-a102-0316b617821d", "server_birth": 1679992148, "glog-msg": "[ark]Listening and serving HTTP on listener 0.0.0.0:9000"}

[0;32mpkreview-backend ready[0m
[1;33mversion:[0m [0;32m{"Git":"pre/v0.13.7:49ad1d9c4-dirty","BuildTime":"2023-03-28T16:26:34+0800","BuildHost":"backend-builder","Type":"docker","Go":"go1.17.12 linux/amd64","Conf":"v0.0.72","Branch":""}[0m
CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS         PORTS                                            NAMES
5c9f106c43e4   plutus:pkreview   "/slots/plutus-server"   11 seconds ago   Up 9 seconds   0.0.0.0:4444->9000/tcp, 0.0.0.0:4544->9168/tcp   pkreview-backend
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pkreview"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E5%8D%95%E7%8B%AC%E6%9B%B4%E6%96%B0GameServer/169/"

source /root/jenkins/jk_func.sh
~/jenkins/analyze_log/analyze_err -url ${BUILD_URL}
sleep 5
check_whole_server $server_name

pkreview-backend Check
pkreview-rpc Check
pkreview-redis Check
pkreview-mongo Check
pkreview-fluentd Check

[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
