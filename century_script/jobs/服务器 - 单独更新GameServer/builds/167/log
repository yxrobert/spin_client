Started by user [8mha:////4NL15lwhNok46o8LpNIYOqAIaurwr6Vm2yW5YSW4R5+wAAAAlh+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAyWEgYu/dLi1CL9ovz8EgDKVWzSvwAAAA==[0mroot
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 单独更新GameServer
[8mha:////4Gam/BArYhVi2EV4UZc8nyJ/tANOnY4aaF3f+6geeF96AAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGleREg7Qk0zRTXdPkREtdE4MUS12LpJQk3UTTNBNj46RUc8M0IwA1tfrjrwAAAA==[0m[SSH] executing pre build script:
server_name="pktest"
variable_args="disable_rtp_limit"

#!/bin/bash
source /root/jenkins/jk_func.sh

if [ -z "$server_name" ]; then
    echo "Error: 没有选择服务器!"
    exit 1
fi

file_lock
echo ${server_name}
check_env_args ${server_name}
echo ${variable_args}

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['game']")
server_port=$(yaml $conf_file "['$server_name']['port']")
echo ${branch_name}

# run
cd /mnt/slots/cc-server
git cd $branch_name
check_last_cmd $branch_name
git pull
check_last_cmd pull
cd /mnt/slots/cc-slots-land/batch
set_env_args ${variable_args}
./compile.sh $server_name && ./build_image.sh $server_name && ./run_image.sh $server_name $server_port
clear_env_args

file_unlock




脚本可执行
pktest
disable_rtp_limit
{'bandit': 'develop', 'game': 'develop', 'cc-conf': 'deploy-cc-conf', 'desc': 'pktest', 'rpc_port': 6676, 'bandit-conf': 'deploy-bandit-conf', 'port': 6666}
develop
Switched to branch 'develop'
remote: Enumerating objects: 9, done.[K
remote: Counting objects:  11% (1/9)[Kremote: Counting objects:  22% (2/9)[Kremote: Counting objects:  33% (3/9)[Kremote: Counting objects:  44% (4/9)[Kremote: Counting objects:  55% (5/9)[Kremote: Counting objects:  66% (6/9)[Kremote: Counting objects:  77% (7/9)[Kremote: Counting objects:  88% (8/9)[Kremote: Counting objects: 100% (9/9)[Kremote: Counting objects: 100% (9/9), done.[K
remote: Compressing objects:  11% (1/9)[Kremote: Compressing objects:  22% (2/9)[Kremote: Compressing objects:  33% (3/9)[Kremote: Compressing objects:  44% (4/9)[Kremote: Compressing objects:  55% (5/9)[Kremote: Compressing objects:  66% (6/9)[Kremote: Compressing objects:  77% (7/9)[Kremote: Compressing objects:  88% (8/9)[Kremote: Compressing objects: 100% (9/9)[Kremote: Compressing objects: 100% (9/9), done.[K
remote: Total 9 (delta 1), reused 0 (delta 0), pack-reused 0[K
Unpacking objects:  11% (1/9)   Unpacking objects:  22% (2/9)   Unpacking objects:  33% (3/9)   Unpacking objects:  44% (4/9)   Unpacking objects:  55% (5/9)   Unpacking objects:  66% (6/9)   Unpacking objects:  77% (7/9)   Unpacking objects:  88% (8/9)   Unpacking objects: 100% (9/9)   Unpacking objects: 100% (9/9), done.
From gitlab.funplus.io:cheesecake/cc-server
   ec3fe40..f52e633  develop    -> origin/develop
 * [new branch]      feature/new_user_rtp_protect -> origin/feature/new_user_rtp_protect
Updating ec3fe40..f52e633
Fast-forward
 server/internal/player/eventPublisher.go |  1 [32m+[m
 server/server/gateway_eventcheck_club.go | 18 [32m++++++++++++[m[31m------[m
 2 files changed, 13 insertions(+), 6 deletions(-)
disable_rtp_limit
disable_rtp_limit
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pktest
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pktest/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pktest_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pktest_dev_bandit
[0;35m           Network:[0m pktest
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pktest-redis:6379
[0;35m Backend-Container:[0m pktest-backend
[1;33m  BANDIT-Container:[0m pktest-rpc
[0;32m Fluentd-Container:[0m pktest-fluentd
[0;32m   Mongo-Container:[0m pktest-mongo
[0;32m   Redis-Container:[0m pktest-redis
[1;33m    BUILD TARGET:[0m game
[1;33m   BUILD COMMAND:[0m cd proto && make server -B && cd .. && server/output/build-server.sh docker
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/cc-server
[1;33m        CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pktest/config.ini
[1;33mCONFIG_FILE_PROD:[0m pktest/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "backend-builder"   --hostname "backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/cc-server":"/slots"   -v "/home/user00/cc/cc-conf":"/cc-conf"   -v "/home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd proto && make server -B && cd .. && server/output/build-server.sh docker"[0m
rm ../server/pb/*.pb.go 2>/dev/null || :
protoc --go_out=../server/pb *.proto
[0;32mbuilding "plutus-server"[0m
[0;33mLDFLAGS[0m = [0;36m-X 'plutus/core.BuildGoVersion=go1.17.12 linux/amd64' -X 'plutus/core.BuildTime=2023-03-28T12:43:22+0800' -X 'plutus/core.BuildType=docker' -X 'plutus/core.BuildHost=backend-builder' -X 'plutus/core.BuildGit=develop:f52e633b6-dirty' -X 'plutus/core.BuildConf=v0.0.73'[0m
[0;33mTARGET[0m = [0;36m/slots/server/cmd/main/plutus-server-next[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pktest/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;32mcopy server config: pktest/config.ini /home/user00/cc/cc-slots-land/stage/app=pktest/app/config.ini[0m
[0;32mremove container: backend-builder[0m
[0;36mreclaim resources: backend-builder 9ca2ffcea2c5[0m
9ca2ffcea2c5
9ca2ffcea2c5
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  6.128MBSending build context to Docker daemon  13.37MBSending build context to Docker daemon  18.38MBSending build context to Docker daemon  26.74MBSending build context to Docker daemon  35.65MBSending build context to Docker daemon  42.34MBSending build context to Docker daemon  47.91MBSending build context to Docker daemon  56.26MBSending build context to Docker daemon   63.5MBSending build context to Docker daemon   67.4MBSending build context to Docker daemon  72.97MBSending build context to Docker daemon  77.99MBSending build context to Docker daemon  86.34MBSending build context to Docker daemon   94.7MBSending build context to Docker daemon  102.5MBSending build context to Docker daemon  110.3MBSending build context to Docker daemon  117.5MBSending build context to Docker daemon  125.3MBSending build context to Docker daemon  133.1MBSending build context to Docker daemon  138.7MBSending build context to Docker daemon  146.5MBSending build context to Docker daemon  154.9MBSending build context to Docker daemon  163.8MBSending build context to Docker daemon  172.7MBSending build context to Docker daemon  181.6MBSending build context to Docker daemon  189.4MBSending build context to Docker daemon  197.8MBSending build context to Docker daemon  206.1MBSending build context to Docker daemon  212.8MBSending build context to Docker daemon  221.2MBSending build context to Docker daemon  229.5MBSending build context to Docker daemon  237.9MBSending build context to Docker daemon  245.7MBSending build context to Docker daemon    254MBSending build context to Docker daemon  262.4MBSending build context to Docker daemon  270.7MBSending build context to Docker daemon  279.6MBSending build context to Docker daemon    288MBSending build context to Docker daemon  296.4MBSending build context to Docker daemon  303.6MBSending build context to Docker daemon  306.8MB
Step 1/5 : FROM alpine:3.12.0
 ---> a24bb4013296
Step 2/5 : ARG app
 ---> Using cache
 ---> 00422b32391e
Step 3/5 : ADD $app/app/ /slots
 ---> 232c77ec4b53
Step 4/5 : WORKDIR /slots
 ---> Running in d8ca444b4538
Removing intermediate container d8ca444b4538
 ---> dceff62a2fc6
Step 5/5 : ENTRYPOINT ["/slots/plutus-server"]
 ---> Running in 4ca9e01d42b8
Removing intermediate container 4ca9e01d42b8
 ---> def200fc8942
Successfully built def200fc8942
Successfully tagged plutus:pktest
[0;32mgc: app=pktest/app/backend[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pktest
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pktest/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pktest_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pktest_dev_bandit
[0;35m           Network:[0m pktest
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pktest-redis:6379
[0;35m Backend-Container:[0m pktest-backend
[1;33m  BANDIT-Container:[0m pktest-rpc
[0;32m Fluentd-Container:[0m pktest-fluentd
[0;32m   Mongo-Container:[0m pktest-mongo
[0;32m   Redis-Container:[0m pktest-redis

[0;32mstart pktest-backend[0m
[0;36m  docker run -d     -e app=pktest.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pktest     -e sys_stage=dev_backend     -e hostname=10.0.84.16     -e port=6666 	--env-file .env     -p 6666:9000 -p 6766:9168     --network pktest     --name pktest-backend     plutus:pktest[0m
[0;36mreclaim resources: pktest-backend 9b5188b245a0[0m
9b5188b245a0
9b5188b245a0
944e2a679a064cd744dc4744bb1b796963196b952ef376cad126e8cd94d5d412
[0;32mwaiting for pktest-backend...[0m
[0;32m=====> try 0 times[0m
curl: (56) Recv failure: Connection reset by peer
[0;32m=====> try 1 times[0m
400 Bad Request{"log_level":"warn","date":"2023-03-28T04:46:04.094Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cgh723428459mu82cgfg","server_id":"cgh722s28459mu82cgdg","server_ip":"172.22.0.6","server_birth":1679978763,"host_name":"944e2a679a06","glog-msg":"[sandwich] [deprecated] should use WithAdapter to initialize pmconf package."}
2023-03-28 04:46:04.094154 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
{"log_level":"warn","date":"2023-03-28T04:46:04.104Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cgh723428459mu82cgg0","server_id":"cgh722s28459mu82cgdg","server_ip":"172.22.0.6","server_birth":1679978763,"host_name":"944e2a679a06","glog-msg":"[sandwich] [deprecated] PmConfPath changed due to sys_env_name and sys_stage, should use sandwich_conf_env","sysConfEnvStaging":"pktest_dev_backend","pm_conf_path":"/pktest_dev_backend"}
{
	"logger": {
		"timelocation": {},
		"host": "pktest-fluentd",
		"type": "logbus",
		"serverbirth": "2023-03-28T00:46:05-04:00",
		"port": 24224,
		"withcaller": false
	},
	"timelocation": {},
	"gmt": {
		"listen": "0.0.0.0:9000",
		"secret": "xkcs;wjngSDGJL;KADlkafas"
	},
	"httplistenaddr": "0.0.0.0:9000",
	"serverbirth": "2023-03-28T00:46:05-04:00",
	"serveropen": "2021-01-01T00:00:00Z",
	"lighthouse": {
		"token": "c3p0zmycr83g00066h6g"
	},
	"app": "pktest.dev",
	"funplus": {
		"url": "https://passport-sandbox-checksession.centurygame.com/server_api.php",
		"paysecret": "o+gt#+v)@-0\u002609my@e0@1c9v\u0026629i02t(kd9ry_sw\u0026j*oi*l4)",
		"serverpayid": "not-support",
		"expire": 3600
	},
	"bi": {
		"host": "",
		"mark": "178_pktest",
		"port": 24224
	},
	"sisyphus": {
		"listen": "0.0.0.0:9000",
		"collection": "idGen",
		"timeout": 10000000000,
		"section": 0
	},
	"postoffice": {
		"listen": "0.0.0.0:9000",
		"serviceurl": "http://pktest-postOffice:9000",
		"router": "/push",
		"reqpushurl": "",
		"appkey": "ca176bf86c3300375acebc07ff6684b0",
		"interval": 10,
		"timeout": 30000000000,
		"appid": 20106,
		"workercount": 20
	},
	"redis": {
		"uri": "pktest-redis:6379",
		"pwd": "",
		"db": 0,
		"timeout": 5000000000,
		"usecluster": false
	},
	"rtm": {
		"servergateurl": "",
		"secretkey": "",
		"connecttimeout": 0,
		"questtimeout": 0,
		"adminuid": 0,
		"projectid": 0,
		"autoreconnect": false,
		"enable": false
	},
	"mongo": {
		"uri": "mongodb://root:passwd@pktest-mongo:27017/?authSource=admin",
		"db": "plutus",
		"connecttimeout": 2000000000,
		"questtimeout": 10000000000,
		"deferduration": 60000000000,
		"lifetime": 3600000000000
	},
	"inbox": {
		"timeout": 10000000000
	},
	"dev": {
		"mode": true,
		"usegops": true,
		"richnewplayer": false
	},
	"gateway": {
		"useentitycache": false
	},
	"canonical": false
}
2023-03-28T04:46:05.563Z	[34minfo[0m	buslogger/logger.go:121	server	{"tags": ["logbus"], "log_xid": "cgh723c28459mu82cggg", "server_ip": "172.22.0.6", "host_name": "944e2a679a06", "server_id": "f84535cb-2edb-44b0-b384-27148483d89a", "server_birth": 1679978765, "role": "bootstrap", "msg": "TimeFake: add: 17442575, now: 2023-10-15 21:55:40.563036211 -0400 EDT"}
2023-03-28T04:46:05.651Z	[34minfo[0m	sandwich@v1.2.85/endpoint.go:269	server	{"tags": ["logbus"], "log_xid": "cgh723c28459mu82cgi0", "server_ip": "172.22.0.6", "host_name": "944e2a679a06", "server_id": "f84535cb-2edb-44b0-b384-27148483d89a", "server_birth": 1679978765, "glog-msg": "[sandwich] sandwich endpoint update summary", "registry_path": "/pktest.dev/sandwich/service/slot/", "entries": ["cggnnbc284512nuilpug_172.22.0.5:8087"], "added": ["cggnnbc284512nuilpug_172.22.0.5:8087"], "keys_removed": [], "keys_now": ["cggnnbc284512nuilpug"], "keys_old": []}
2023-03-28T04:46:12.695Z	[34minfo[0m	buslogger/logger.go:101	server	{"tags": ["logbus"], "log_xid": "cgh725428459mu82cgj0", "server_ip": "172.22.0.6", "host_name": "944e2a679a06", "server_id": "f84535cb-2edb-44b0-b384-27148483d89a", "server_birth": 1679978765, "role": "server", "msg": "game server start..."}
2023-03-28T04:46:12.957Z	[35mdebug[0m	ark@v1.2.2/ark.go:394	server	{"tags": ["logbus"], "log_xid": "cgh725428459mu82cgk0", "server_ip": "172.22.0.6", "host_name": "944e2a679a06", "server_id": "f84535cb-2edb-44b0-b384-27148483d89a", "server_birth": 1679978765, "glog-msg": "[ark]Listening and serving HTTP on listener 0.0.0.0:9000"}

[0;32mpktest-backend ready[0m
[1;33mversion:[0m [0;32m{"Git":"develop:f52e633b6-dirty","BuildTime":"2023-03-28T12:43:22+0800","BuildHost":"backend-builder","Type":"docker","Go":"go1.17.12 linux/amd64","Conf":"v0.0.73","Branch":""}[0m
CONTAINER ID   IMAGE           COMMAND                  CREATED          STATUS         PORTS                                            NAMES
944e2a679a06   plutus:pktest   "/slots/plutus-server"   10 seconds ago   Up 9 seconds   0.0.0.0:6666->9000/tcp, 0.0.0.0:6766->9168/tcp   pktest-backend
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pktest"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E5%8D%95%E7%8B%AC%E6%9B%B4%E6%96%B0GameServer/167/"

source /root/jenkins/jk_func.sh
~/jenkins/analyze_log/analyze_err -url ${BUILD_URL}
sleep 5
check_whole_server $server_name

pktest-backend Check
pktest-rpc Check
pktest-redis Check
pktest-mongo Check
pktest-fluentd Check

[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
