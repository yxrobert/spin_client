Started by user [8mha:////4NL15lwhNok46o8LpNIYOqAIaurwr6Vm2yW5YSW4R5+wAAAAlh+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAyWEgYu/dLi1CL9ovz8EgDKVWzSvwAAAA==[0mroot
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 单独更新GameServer
[8mha:////4FTrEXMyjx4oGB9szHPHinlrBWx7WP+1qK6WL+5Gc9EdAAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGFQMzg9QUMzNzXQOjxCRdE0sTE91EC/M0XQNTAyMDCxNLC9NUMwBTPF92rwAAAA==[0m[SSH] executing pre build script:
server_name="pkcp"
variable_args="disable_rtp_limit"

#!/bin/bash
source /root/jenkins/jk_func.sh

file_lock
echo ${server_name}
check_env_args ${server_name}
echo ${variable_args}

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['game']")
server_port=$(yaml $conf_file "['$server_name']['port']")
echo ${branch_name}

# run
cd /mnt/slots/cc-server
git cd $branch_name
check_last_cmd $branch_name
git pull
check_last_cmd pull
cd /mnt/slots/cc-slots-land/batch
set_env_args ${variable_args}
./compile.sh $server_name && ./build_image.sh $server_name && ./run_image.sh $server_name $server_port
clear_env_args

file_unlock




脚本可执行
pkcp
disable_rtp_limit
{'bandit': 'develop', 'game': 'feature/spin_max_bonus', 'cc-conf': 'deploy-cc-conf', 'desc': 'pkcp', 'rpc_port': 10009, 'bandit-conf': 'deploy-bandit-conf', 'port': 9999}
feature/spin_max_bonus
Already on 'feature/spin_max_bonus'
remote: Enumerating objects: 14, done.[K
remote: Counting objects:   7% (1/14)[Kremote: Counting objects:  14% (2/14)[Kremote: Counting objects:  21% (3/14)[Kremote: Counting objects:  28% (4/14)[Kremote: Counting objects:  35% (5/14)[Kremote: Counting objects:  42% (6/14)[Kremote: Counting objects:  50% (7/14)[Kremote: Counting objects:  57% (8/14)[Kremote: Counting objects:  64% (9/14)[Kremote: Counting objects:  71% (10/14)[Kremote: Counting objects:  78% (11/14)[Kremote: Counting objects:  85% (12/14)[Kremote: Counting objects:  92% (13/14)[Kremote: Counting objects: 100% (14/14)[Kremote: Counting objects: 100% (14/14), done.[K
remote: Compressing objects:   7% (1/14)[Kremote: Compressing objects:  14% (2/14)[Kremote: Compressing objects:  21% (3/14)[Kremote: Compressing objects:  28% (4/14)[Kremote: Compressing objects:  35% (5/14)[Kremote: Compressing objects:  42% (6/14)[Kremote: Compressing objects:  50% (7/14)[Kremote: Compressing objects:  57% (8/14)[Kremote: Compressing objects:  64% (9/14)[Kremote: Compressing objects:  71% (10/14)[Kremote: Compressing objects:  78% (11/14)[Kremote: Compressing objects:  85% (12/14)[Kremote: Compressing objects:  92% (13/14)[Kremote: Compressing objects: 100% (14/14)[Kremote: Compressing objects: 100% (14/14), done.[K
remote: Total 14 (delta 1), reused 0 (delta 0), pack-reused 0[K
Unpacking objects:   7% (1/14)   Unpacking objects:  14% (2/14)   Unpacking objects:  21% (3/14)   Unpacking objects:  28% (4/14)   Unpacking objects:  35% (5/14)   Unpacking objects:  42% (6/14)   Unpacking objects:  50% (7/14)   Unpacking objects:  57% (8/14)   Unpacking objects:  64% (9/14)   Unpacking objects:  71% (10/14)   Unpacking objects:  78% (11/14)   Unpacking objects:  85% (12/14)   Unpacking objects:  92% (13/14)   Unpacking objects: 100% (14/14)   Unpacking objects: 100% (14/14), done.
From gitlab.funplus.io:cheesecake/cc-server
   e591b83..695bf9d  feature/spin_max_bonus -> origin/feature/spin_max_bonus
Updating e591b83..695bf9d
Fast-forward
 proto/award.proto                                       |  4 [32m+++[m[31m-[m
 server/go.mod                                           |  2 [32m+[m[31m-[m
 server/go.sum                                           |  4 [32m++[m[31m--[m
 server/internal/activity/iactivity/spinmax/processor.go | 10 [32m+++++++++[m[31m-[m
 server/internal/constant/origin.go                      |  9 [32m++++++[m[31m---[m
 5 files changed, 21 insertions(+), 8 deletions(-)
disable_rtp_limit
disable_rtp_limit
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkcp
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkcp/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkcp_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkcp_dev_bandit
[0;35m           Network:[0m pkcp
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkcp-redis:6379
[0;35m Backend-Container:[0m pkcp-backend
[1;33m  BANDIT-Container:[0m pkcp-rpc
[0;32m Fluentd-Container:[0m pkcp-fluentd
[0;32m   Mongo-Container:[0m pkcp-mongo
[0;32m   Redis-Container:[0m pkcp-redis
[1;33m    BUILD TARGET:[0m game
[1;33m   BUILD COMMAND:[0m cd proto && make server -B && cd .. && server/output/build-server.sh docker
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/cc-server
[1;33m        CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pkcp/config.ini
[1;33mCONFIG_FILE_PROD:[0m pkcp/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "backend-builder"   --hostname "backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/cc-server":"/slots"   -v "/home/user00/cc/cc-conf":"/cc-conf"   -v "/home/user00/cc/cc-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/cc-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd proto && make server -B && cd .. && server/output/build-server.sh docker"[0m
rm ../server/pb/*.pb.go 2>/dev/null || :
protoc --go_out=../server/pb *.proto
[0;32mbuilding "plutus-server"[0m
[0;33mLDFLAGS[0m = [0;36m-X 'plutus/core.BuildGoVersion=go1.17.12 linux/amd64' -X 'plutus/core.BuildTime=2023-03-27T19:42:57+0800' -X 'plutus/core.BuildType=docker' -X 'plutus/core.BuildHost=backend-builder' -X 'plutus/core.BuildGit=feature/spin_max_bonus:695bf9dfa-dirty' -X 'plutus/core.BuildConf=v0.0.74-0.20230327113241-990a246c0679'[0m
[0;33mTARGET[0m = [0;36m/slots/server/cmd/main/plutus-server-next[0m
[0;31mgo: downloading gitlab.funplus.io/cheesecake/cc-conf v0.0.74-0.20230327113241-990a246c0679[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pkcp/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;32mcopy server config: pkcp/config.ini /home/user00/cc/cc-slots-land/stage/app=pkcp/app/config.ini[0m
[0;32mremove container: backend-builder[0m
[0;36mreclaim resources: backend-builder 805bf9f27a47[0m
805bf9f27a47
805bf9f27a47
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  8.356MBSending build context to Docker daemon  13.93MBSending build context to Docker daemon  21.73MBSending build context to Docker daemon  27.85MBSending build context to Docker daemon  35.65MBSending build context to Docker daemon  43.45MBSending build context to Docker daemon  51.25MBSending build context to Docker daemon  58.49MBSending build context to Docker daemon  66.85MBSending build context to Docker daemon  74.65MBSending build context to Docker daemon  81.89MBSending build context to Docker daemon  88.57MBSending build context to Docker daemon  95.26MBSending build context to Docker daemon  100.3MBSending build context to Docker daemon  106.4MBSending build context to Docker daemon  113.6MBSending build context to Docker daemon  121.4MBSending build context to Docker daemon  128.7MBSending build context to Docker daemon  136.5MBSending build context to Docker daemon  143.2MBSending build context to Docker daemon  150.4MBSending build context to Docker daemon  158.2MBSending build context to Docker daemon    166MBSending build context to Docker daemon  173.8MBSending build context to Docker daemon  181.6MBSending build context to Docker daemon  188.8MBSending build context to Docker daemon  196.6MBSending build context to Docker daemon  204.4MBSending build context to Docker daemon  212.2MBSending build context to Docker daemon  218.9MBSending build context to Docker daemon  224.5MBSending build context to Docker daemon  232.8MBSending build context to Docker daemon  240.1MBSending build context to Docker daemon  243.4MBSending build context to Docker daemon  248.4MBSending build context to Docker daemon  255.7MBSending build context to Docker daemon  262.4MBSending build context to Docker daemon  270.7MBSending build context to Docker daemon  273.5MBSending build context to Docker daemon  275.2MBSending build context to Docker daemon    278MBSending build context to Docker daemon  285.8MBSending build context to Docker daemon  294.1MBSending build context to Docker daemon  301.9MBSending build context to Docker daemon  306.6MB
Step 1/5 : FROM alpine:3.12.0
 ---> a24bb4013296
Step 2/5 : ARG app
 ---> Using cache
 ---> 00422b32391e
Step 3/5 : ADD $app/app/ /slots
 ---> 51354f46dc76
Step 4/5 : WORKDIR /slots
 ---> Running in 8df25e4c3ac5
Removing intermediate container 8df25e4c3ac5
 ---> 532754af1ddd
Step 5/5 : ENTRYPOINT ["/slots/plutus-server"]
 ---> Running in d06c6101518f
Removing intermediate container d06c6101518f
 ---> 3782b015ab62
Successfully built 3782b015ab62
Successfully tagged plutus:pkcp
[0;32mgc: app=pkcp/app/backend[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkcp
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkcp/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkcp_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkcp_dev_bandit
[0;35m           Network:[0m pkcp
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkcp-redis:6379
[0;35m Backend-Container:[0m pkcp-backend
[1;33m  BANDIT-Container:[0m pkcp-rpc
[0;32m Fluentd-Container:[0m pkcp-fluentd
[0;32m   Mongo-Container:[0m pkcp-mongo
[0;32m   Redis-Container:[0m pkcp-redis

[0;32mstart pkcp-backend[0m
[0;36m  docker run -d     -e app=pkcp.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pkcp     -e sys_stage=dev_backend     -e hostname=10.0.84.16     -e port=9999 	--env-file .env     -p 9999:9000 -p 10099:9168     --network pkcp     --name pkcp-backend     plutus:pkcp[0m
[0;36mreclaim resources: pkcp-backend 77cdf3123ba4[0m
77cdf3123ba4
77cdf3123ba4
5f90c2e3fb7f8ed0383a46192349802eee470b5c7a165f1a1377df3de2f8835e
[0;32mwaiting for pkcp-backend...[0m
[0;32m=====> try 0 times[0m
curl: (56) Recv failure: Connection reset by peer
[0;32m=====> try 1 times[0m
400 Bad Request2023-03-27 11:45:41.278434 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
{"log_level":"warn","date":"2023-03-27T11:45:41.278Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cggo3pc28458aenhih2g","server_id":"cggo3pc28458aenhih0g","server_ip":"172.21.0.6","server_birth":1679917541,"host_name":"5f90c2e3fb7f","glog-msg":"[sandwich] [deprecated] should use WithAdapter to initialize pmconf package."}
{"log_level":"warn","date":"2023-03-27T11:45:41.290Z","dd_meta_channel":"server","tags":["logbus"],"log_xid":"cggo3pc28458aenhih30","server_id":"cggo3pc28458aenhih0g","server_ip":"172.21.0.6","server_birth":1679917541,"host_name":"5f90c2e3fb7f","glog-msg":"[sandwich] [deprecated] PmConfPath changed due to sys_env_name and sys_stage, should use sandwich_conf_env","sysConfEnvStaging":"pkcp_dev_backend","pm_conf_path":"/pkcp_dev_backend"}
{
	"logger": {
		"timelocation": {},
		"host": "pkcp-fluentd",
		"type": "logbus",
		"serverbirth": "2023-03-27T07:45:42-04:00",
		"port": 24224,
		"withcaller": false
	},
	"timelocation": {},
	"gmt": {
		"listen": "0.0.0.0:9000",
		"secret": "xkcs;wjngSDGJL;KADlkafas"
	},
	"httplistenaddr": "0.0.0.0:9000",
	"serverbirth": "2023-03-27T07:45:42-04:00",
	"serveropen": "2021-01-01T00:00:00Z",
	"lighthouse": {
		"token": "c3p0zmycr83g00066h6g"
	},
	"app": "pkcp.dev",
	"funplus": {
		"url": "https://passport-sandbox-checksession.centurygame.com/server_api.php",
		"paysecret": "o+gt#+v)@-0\u002609my@e0@1c9v\u0026629i02t(kd9ry_sw\u0026j*oi*l4)",
		"serverpayid": "not-support",
		"expire": 3600
	},
	"bi": {
		"host": "",
		"mark": "178_pkcp",
		"port": 24224
	},
	"sisyphus": {
		"listen": "0.0.0.0:9000",
		"collection": "idGen",
		"timeout": 10000000000,
		"section": 0
	},
	"postoffice": {
		"listen": "0.0.0.0:9000",
		"serviceurl": "http://pkcp-postOffice:9000",
		"router": "/push",
		"reqpushurl": "",
		"appkey": "ca176bf86c3300375acebc07ff6684b0",
		"interval": 10,
		"timeout": 30000000000,
		"appid": 20106,
		"workercount": 20
	},
	"redis": {
		"uri": "pkcp-redis:6379",
		"pwd": "",
		"db": 0,
		"timeout": 5000000000,
		"usecluster": false
	},
	"rtm": {
		"servergateurl": "",
		"secretkey": "",
		"connecttimeout": 0,
		"questtimeout": 0,
		"adminuid": 0,
		"projectid": 0,
		"autoreconnect": false,
		"enable": false
	},
	"mongo": {
		"uri": "mongodb://root:passwd@pkcp-mongo:27017/?authSource=admin",
		"db": "plutus",
		"connecttimeout": 2000000000,
		"questtimeout": 10000000000,
		"deferduration": 60000000000,
		"lifetime": 3600000000000
	},
	"inbox": {
		"timeout": 10000000000
	},
	"dev": {
		"mode": true,
		"usegops": false,
		"richnewplayer": false
	},
	"gateway": {
		"useentitycache": false
	},
	"canonical": false
}
2023-03-27T11:45:43.229Z	[34minfo[0m	buslogger/logger.go:121	server	{"tags": ["logbus"], "log_xid": "cggo3ps28458aenhih3g", "server_ip": "172.21.0.6", "host_name": "5f90c2e3fb7f", "server_id": "3bf9c420-eda8-4707-b5ae-3a3f9ac689c6", "server_birth": 1679917542, "role": "bootstrap", "msg": "TimeFake: add: 21853559, now: 2023-12-05 05:11:42.229083933 -0500 EST"}
2023-03-27T11:45:43.334Z	[34minfo[0m	sandwich@v1.2.85/endpoint.go:269	server	{"tags": ["logbus"], "log_xid": "cggo3ps28458aenhih50", "server_ip": "172.21.0.6", "host_name": "5f90c2e3fb7f", "server_id": "3bf9c420-eda8-4707-b5ae-3a3f9ac689c6", "server_birth": 1679917542, "glog-msg": "[sandwich] sandwich endpoint update summary", "registry_path": "/pkcp.dev/sandwich/service/slot/", "entries": ["cggnkns28455ja2o77k0_172.21.0.5:8087"], "added": ["cggnkns28455ja2o77k0_172.21.0.5:8087"], "keys_removed": [], "keys_now": ["cggnkns28455ja2o77k0"], "keys_old": []}
2023-03-27T11:45:50.033Z	[34minfo[0m	buslogger/logger.go:101	server	{"tags": ["logbus"], "log_xid": "cggo3rk28458aenhih60", "server_ip": "172.21.0.6", "host_name": "5f90c2e3fb7f", "server_id": "3bf9c420-eda8-4707-b5ae-3a3f9ac689c6", "server_birth": 1679917542, "role": "server", "msg": "game server start..."}
2023-03-27T11:45:50.310Z	[35mdebug[0m	ark@v1.2.2/ark.go:394	server	{"tags": ["logbus"], "log_xid": "cggo3rk28458aenhih70", "server_ip": "172.21.0.6", "host_name": "5f90c2e3fb7f", "server_id": "3bf9c420-eda8-4707-b5ae-3a3f9ac689c6", "server_birth": 1679917542, "glog-msg": "[ark]Listening and serving HTTP on listener 0.0.0.0:9000"}

[0;32mpkcp-backend ready[0m
[1;33mversion:[0m [0;32m{"Git":"feature/spin_max_bonus:695bf9dfa-dirty", "BuildTime":"2023-03-27T19:42:57+0800", "BuildHost":"backend-builder", "Type":"docker", "Go":"go1.17.12 linux/amd64", "Conf":"v0.0.74-0.20230327113241-990a246c0679", "Branch":""}[0m
CONTAINER ID   IMAGE         COMMAND                  CREATED          STATUS         PORTS                                             NAMES
5f90c2e3fb7f   plutus:pkcp   "/slots/plutus-server"   12 seconds ago   Up 9 seconds   0.0.0.0:9999->9000/tcp, 0.0.0.0:10099->9168/tcp   pkcp-backend
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pkcp"

source /root/jenkins/jk_func.sh
sleep 5
check_whole_server $server_name
pkcp-backend Check
pkcp-rpc Check
pkcp-redis Check
pkcp-mongo Check
pkcp-fluentd Check

[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
