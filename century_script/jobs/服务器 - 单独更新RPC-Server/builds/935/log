Started by user [8mha:////4NL15lwhNok46o8LpNIYOqAIaurwr6Vm2yW5YSW4R5+wAAAAlh+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAyWEgYu/dLi1CL9ovz8EgDKVWzSvwAAAA==[0mroot
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 单独更新RPC-Server
[8mha:////4IZzx6r7P1V4PLHC1FqYe23jfgz/oZuqrf1oP5KrN4k2AAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGFQNzc8vU5DRDXdPURANdk7S0NN0kA0tzXYMkC4u0VCODJJMkMwCeqEuarwAAAA==[0m[SSH] executing pre build script:
server_name="pk7014"

#!/bin/bash 
source /root/jenkins/jk_func.sh

file_lock

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['bandit']")
rpc_port=$(yaml $conf_file "['$server_name']['rpc_port']")

cd /mnt/slots/bandit-server
git cd $branch_name
check_last_cmd branch

git pull
check_last_cmd pull

cd /mnt/slots/cc-slots-land/batch
./compile_rpc.sh $server_name && ./build_image_rpc.sh $server_name && ./run_image_rpc.sh $server_name $rpc_port

file_unlock
脚本可执行
{'bandit': 'feature/piggyPinata', 'game': 'feature/piggyPinata', 'cc-conf': 'deploy-cc-conf', 'desc': 'pk7014', 'rpc_port': 7114, 'bandit-conf': 'deploy-bandit-conf', 'port': 7204}
Switched to branch 'feature/piggyPinata'
remote: Enumerating objects: 6, done.[K
remote: Counting objects:  16% (1/6)[Kremote: Counting objects:  33% (2/6)[Kremote: Counting objects:  50% (3/6)[Kremote: Counting objects:  66% (4/6)[Kremote: Counting objects:  83% (5/6)[Kremote: Counting objects: 100% (6/6)[Kremote: Counting objects: 100% (6/6), done.[K
remote: Compressing objects:  16% (1/6)[Kremote: Compressing objects:  33% (2/6)[Kremote: Compressing objects:  50% (3/6)[Kremote: Compressing objects:  66% (4/6)[Kremote: Compressing objects:  83% (5/6)[Kremote: Compressing objects: 100% (6/6)[Kremote: Compressing objects: 100% (6/6), done.[K
remote: Total 6 (delta 0), reused 0 (delta 0), pack-reused 0[K
Unpacking objects:  16% (1/6)   Unpacking objects:  33% (2/6)   Unpacking objects:  50% (3/6)   Unpacking objects:  66% (4/6)   Unpacking objects:  83% (5/6)   Unpacking objects: 100% (6/6)   Unpacking objects: 100% (6/6), done.
From gitlab.funplus.io:fruities/bandit-server
   f9d5293..6c9724d  feature/piggyPinata -> origin/feature/piggyPinata
Updating f9d5293..6c9724d
Fast-forward
 themes/game/piggyPinata/gamePick.go | 19 [32m++++++++++++++++[m[31m---[m
 1 file changed, 16 insertions(+), 3 deletions(-)
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7014
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7014/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7014/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7014/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7014/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7014_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7014_dev_bandit
[0;35m           Network:[0m pk7014
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7014-redis:6379
[0;35m Backend-Container:[0m pk7014-backend
[1;33m  BANDIT-Container:[0m pk7014-rpc
[0;32m Fluentd-Container:[0m pk7014-fluentd
[0;32m   Mongo-Container:[0m pk7014-mongo
[0;32m   Redis-Container:[0m pk7014-redis
[1;33m            DATE:[0m 2023-03-27T18:34:52+0800
[1;33m   BUILD COMMAND:[0m cd bandit-server/cmd/server && go build -ldflags '-X main.buildTime=2023-03-27T18:34:52+0800 -X main.buildCodeVer=feature/piggyPinata:6c9724d -X main.buildConfVer=v1.1.16'
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m rpc-backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/bandit-server feature/piggyPinata:6c9724d
[1;33m        CONF_DIR:[0m /home/user00/cc/bandit-conf v1.1.16
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pk7014/config.ini
[1;33mCONFIG_FILE_PROD:[0m pk7014/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "rpc-backend-builder"   --hostname "rpc-backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/bandit-server":"/slots/bandit-server"   -v "/home/user00/cc/bandit-conf":"/slots/bandit-conf"   -v "/home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd bandit-server/cmd/server && go build -ldflags '-X main.buildTime=2023-03-27T18:34:52+0800 -X main.buildCodeVer=feature/piggyPinata:6c9724d -X main.buildConfVer=v1.1.16'"[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pk7014/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/cmd/server/server" "/home/user00/cc/cc-slots-land/stage/app=pk7014/app/bandit-server"[0m
[0;32mcopy theme collector data to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/themes/data" "/home/user00/cc/cc-slots-land/stage/app=pk7014/app/data"[0m
[0;32mremove container: rpc-backend-builder[0m
[0;36mreclaim resources: rpc-backend-builder fc38a33849be[0m
fc38a33849be
fc38a33849be
[0;36mRPC_APP: pk7014-rpc[0m
[0;36mIMAGE: plutus:pk7014-rpc[0m
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  7.242MBSending build context to Docker daemon  14.48MBSending build context to Docker daemon  21.73MBSending build context to Docker daemon  29.52MBSending build context to Docker daemon  37.88MBSending build context to Docker daemon  45.68MBSending build context to Docker daemon  53.48MBSending build context to Docker daemon  61.83MBSending build context to Docker daemon  70.19MBSending build context to Docker daemon  76.87MBSending build context to Docker daemon  84.12MBSending build context to Docker daemon  91.36MBSending build context to Docker daemon  97.48MBSending build context to Docker daemon  104.7MBSending build context to Docker daemon  112.5MBSending build context to Docker daemon  118.1MBSending build context to Docker daemon    122MBSending build context to Docker daemon  126.5MBSending build context to Docker daemon  133.1MBSending build context to Docker daemon  139.3MBSending build context to Docker daemon  147.1MBSending build context to Docker daemon  154.9MBSending build context to Docker daemon  162.7MBSending build context to Docker daemon  169.9MBSending build context to Docker daemon  177.7MBSending build context to Docker daemon  184.4MBSending build context to Docker daemon  188.3MBSending build context to Docker daemon  191.6MBSending build context to Docker daemon    195MBSending build context to Docker daemon  199.4MBSending build context to Docker daemon  205.6MBSending build context to Docker daemon  210.6MBSending build context to Docker daemon  216.7MBSending build context to Docker daemon  223.4MBSending build context to Docker daemon  230.6MBSending build context to Docker daemon  238.4MBSending build context to Docker daemon  246.8MBSending build context to Docker daemon  254.6MBSending build context to Docker daemon  262.9MBSending build context to Docker daemon  271.3MBSending build context to Docker daemon  278.5MBSending build context to Docker daemon  284.1MBSending build context to Docker daemon  290.8MBSending build context to Docker daemon  292.4MB
Step 1/6 : FROM alpine:3.14
 ---> dd53f409bf0b
Step 2/6 : RUN apk update 	&& apk add tzdata     && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime     && echo "Asia/Shanghai" >  /etc/timezone 	&& echo 'alias l="ls -ltA"' >> ~/.bashrc
 ---> Using cache
 ---> 5ad6219d23d9
Step 3/6 : ARG app
 ---> Using cache
 ---> 6128053649fb
Step 4/6 : ADD $app/app/ /slots
 ---> 17cec7a106a6
Step 5/6 : WORKDIR /slots
 ---> Running in e57c7961cb2f
Removing intermediate container e57c7961cb2f
 ---> 67cff64e5df0
Step 6/6 : ENTRYPOINT ["/slots/bandit-server"]
 ---> Running in 6288273eaf63
Removing intermediate container 6288273eaf63
 ---> 191752fb6e99
Successfully built 191752fb6e99
Successfully tagged plutus:pk7014-rpc
[0;32mgc: app=pk7014/app/rpc[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7014
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7014/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7014/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7014/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7014/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7014_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7014_dev_bandit
[0;35m           Network:[0m pk7014
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7014-redis:6379
[0;35m Backend-Container:[0m pk7014-backend
[1;33m  BANDIT-Container:[0m pk7014-rpc
[0;32m Fluentd-Container:[0m pk7014-fluentd
[0;32m   Mongo-Container:[0m pk7014-mongo
[0;32m   Redis-Container:[0m pk7014-redis

[0;32mstart pk7014-rpc[0m
[0;36m  docker run -d     -e app=pk7014.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pk7014     -e sys_stage=dev_bandit     -e hostname=10.0.84.16     -e TZ=Asia/Shanghai     -e log_server_host=pk7014-fluentd     -e log_server_port=24224     -e redis_uri=pk7014-redis:6379     -e redis_passwd=     -e redis_db=0     -v /home/user00/cc/bandit-server/configs:/slots/configs/     -e panel_storage=/slots/data/gen/rawdata/panel_storage     --network pk7014     --name pk7014-rpc     plutus:pk7014-rpc[0m
[0;36mreclaim resources: pk7014-rpc 672d28ece04b[0m
672d28ece04b
672d28ece04b
ba5ac7cdf695e6a512dbd47b224fe54c04032a2042faade8460b49752c409414
/slots <nil>
configs/toml/dev.toml
2023-03-27 18:36:04.651489 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
configs {"RedisName":"","RedisEnableMonitor":true,"RedisAddrs":["127.0.0.1:6379"],"RedisDB":0,"RedisUsername":"","RedisPassword":"","RedisMaxRetries":3,"RedisMinRetryBackoff":8000000,"RedisMaxRetryBackoff":512000000,"RedisConnDialTimeout":5000000000,"RedisSocketReadTimeout":3000000000,"RedisSocketWriteTimeout":3000000000,"RedisConnPoolSize":0,"RedisMinIdleConns":0,"RedisConnMaxAge":0,"RedisConnPoolTimeout":0,"RedisIdleConnTimeout":300000000000,"RedisIdleConnCheckFrequency":60000000000,"RedisCluster":false,"RedisClusterReadOnly":false,"RedisClusterRouteRandomly":false,"RedisClusterRouteByLatency":false,"RedisMasterName":"","KeyTokenInHeader":"Authorization","AuthSchema":"Bearer","SigningKeys":["e!L7pH4y","aQSdp5x*","J@I1R\u0026Op"],"TokenExpiration":604800000000000,"ServerName":"bandit-server","ApiToken":"c1c61sff2hn00006gg2g","PassportUrl":"http://passport-dev-cn.ifunplus.cn:8000/server_api.php","PmConfPath":"/pkjy_dev","AutoConfFiles":"","DbAgentType":"mysql","MysqlPassword":"","MysqlHost":"127.0.0.1","DataServerHost":"127.0.0.1","MysqlUser":"root","MysqlDbName":"bandit-server","DbProxyEndpoints":null,"DbMaxOpenConns":20,"DbTimeout":3000000000,"DbMaxIdleConns":20,"MysqlPort":3306,"DataServerPort":3308,"EtcdEndpoint":["10.0.84.74:2379"],"MicroEtcdEndpoint":["127.0.0.1:2379"],"SiidUrl":"http://127.0.0.1:16000/v1/siid","IdTryTimes":3,"UseSiid":false,"TcpPort":8087,"TcpSendChanSize":1024,"OpenTcpGate":false,"HttpPort":8088,"HttpRateLimit":0,"OpenHttpGate":false,"PipelineEnable":false,"PipelineCacheExpiration":300000000000,"MonitorPort":9168,"PrometheusPort":9158,"ActorPort":9088,"RpcPort":8089,"Development":true,"OpenEtcd":false,"UseMysql":false,"UseRedis":false}
2023-03-27T18:36:04.661+0800	[35mdebug[0m	logbus/basic_logger.go:69	monitor	{"tags": ["monitor"], "log_xid": "cggn3542845c2mrcm4q0", "server_id": "cggn3542845c2mrcm4o0", "server_ip": "192.168.96.5", "server_birth": 1679913364, "host_name": "ba5ac7cdf695", "prometheus [http] listening on": ":9158", "path": "/metrics"}
2023-03-27T18:36:04.662+0800	[34minfo[0m	logbus/logger.go:103	server	{"tags": ["logbus"], "log_xid": "cggn3542845c2mrcm4r0", "server_birth": 1679913364, "host_name": "ba5ac7cdf695", "server_tag": "bandit", "server_id": "989e4846-1d7b-45ba-942d-e6f6ea84ad9b", "server_ip": "192.168.96.5", "era": "2023-03-27T18:36:04+08:00", "code": " feature/piggyPinata:6c9724d", "conf": "v1.1.16", "NumCPU": 8, "GOMAXPROCS": 8}
2023-03-27T18:36:04.664+0800	[34minfo[0m	sjaeger/log.go:19	server	{"tags": ["logbus"], "log_xid": "cggn3542845c2mrcm4s0", "server_birth": 1679913364, "host_name": "ba5ac7cdf695", "server_tag": "bandit", "server_id": "989e4846-1d7b-45ba-942d-e6f6ea84ad9b", "server_ip": "192.168.96.5", "era": "2023-03-27T18:36:04+08:00", "code": " feature/piggyPinata:6c9724d", "conf": "v1.1.16", "glog-msg": "[sandwich jaeger] Initializing logging reporter\n"}
2023-03-27T18:36:04.665+0800	[33mwarn[0m	slog/slog.go:53	server	{"tags": ["logbus"], "log_xid": "cggn3542845c2mrcm4t0", "server_birth": 1679913364, "host_name": "ba5ac7cdf695", "server_tag": "bandit", "server_id": "989e4846-1d7b-45ba-942d-e6f6ea84ad9b", "server_ip": "192.168.96.5", "era": "2023-03-27T18:36:04+08:00", "code": " feature/piggyPinata:6c9724d", "conf": "v1.1.16", "glog-msg": "[sandwich] [deprecated] should use WithAdapter to initialize pmconf package."}
2023-03-27T18:36:04.668+0800	[33mwarn[0m	slog/slog.go:53	server	{"tags": ["logbus"], "log_xid": "cggn3542845c2mrcm4u0", "server_birth": 1679913364, "host_name": "ba5ac7cdf695", "server_tag": "bandit", "server_id": "989e4846-1d7b-45ba-942d-e6f6ea84ad9b", "server_ip": "192.168.96.5", "era": "2023-03-27T18:36:04+08:00", "code": " feature/piggyPinata:6c9724d", "conf": "v1.1.16", "glog-msg": "[sandwich] [deprecated] PmConfPath changed due to sys_env_name and sys_stage, should use sandwich_conf_env", "sysConfEnvStaging": "pk7014_dev_bandit", "pm_conf_path": "/pk7014_dev_bandit"}
PmConfPath = /pk7014_dev_bandit/, ETCD endpoints = [10.0.84.16:2379]
etcd_endpoints = [10.0.84.16:2379]
./run_image_rpc.sh: line 45: jq: command not found
2023-03-27 18:36:04.651489 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pk7014"

source /root/jenkins/jk_func.sh
sleep 5
check_whole_server $server_name

curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "text","text": {"content": "Jenkins-RPC-Server['"${server_name}"'] Restart OK"}}'
pk7014-backend Check
pk7014-rpc Check
pk7014-redis Check
pk7014-mongo Check
pk7014-fluentd Check
{"errcode":0,"errmsg":"ok"}
[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
