Started by user [8mha:////4HzE0KdkKUoEe3LZuhNgH6yc83P/GTxEBP+eXA1cZtU+AAAAmR+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAzOEgZe/dLi1CL9ksTMiszEfAA0j2PtwgAAAA==[0mhetaixiao
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 单独更新RPC-Server
[8mha:////4FQlQClnSd4cGicFzB5yYJ18sP7HaQB+hIrynzhkhzBLAAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGFQtLQyNTC1MDXQtDMzNdE/OUZN3EZFNDXTMjc8MUQyMTi5QkSwDQ5ESfrwAAAA==[0m[SSH] executing pre build script:
server_name="pktest"

#!/bin/bash 
source /root/jenkins/jk_func.sh

if [ -z "$server_name" ]; then
    echo "Error: 没有选择服务器!"
    exit 1
fi

file_lock  || { echo "其他任务运行中，请稍后执行"; exit 1; }

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['bandit']")
rpc_port=$(yaml $conf_file "['$server_name']['rpc_port']")

cd /mnt/slots/bandit-server
git cd $branch_name
check_last_cmd branch

git pull
check_last_cmd pull

cd /mnt/slots/cc-slots-land/batch
./compile_rpc.sh $server_name && ./build_image_rpc.sh $server_name && ./run_image_rpc.sh $server_name $rpc_port

file_unlock
脚本可执行
{'bandit': 'develop', 'game': 'develop', 'cc-conf': 'deploy-cc-conf', 'desc': 'pktest', 'rpc_port': 6676, 'bandit-conf': 'deploy-bandit-conf', 'port': 6666}
Already on 'develop'
Already up-to-date.
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pktest
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pktest/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pktest_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pktest_dev_bandit
[0;35m           Network:[0m pktest
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pktest-redis:6379
[0;35m Backend-Container:[0m pktest-backend
[1;33m  BANDIT-Container:[0m pktest-rpc
[0;32m Fluentd-Container:[0m pktest-fluentd
[0;32m   Mongo-Container:[0m pktest-mongo
[0;32m   Redis-Container:[0m pktest-redis
[1;33m            DATE:[0m 2023-03-30T17:53:03+0800
[1;33m   BUILD COMMAND:[0m cd bandit-server/cmd/server && go build -ldflags '-X main.buildTime=2023-03-30T17:53:03+0800 -X main.buildCodeVer=develop:fd84c07 -X main.buildConfVer=v1.1.16'
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m rpc-backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/bandit-server develop:fd84c07
[1;33m        CONF_DIR:[0m /home/user00/cc/bandit-conf v1.1.16
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pktest/config.ini
[1;33mCONFIG_FILE_PROD:[0m pktest/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "rpc-backend-builder"   --hostname "rpc-backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/bandit-server":"/slots/bandit-server"   -v "/home/user00/cc/bandit-conf":"/slots/bandit-conf"   -v "/home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd bandit-server/cmd/server && go build -ldflags '-X main.buildTime=2023-03-30T17:53:03+0800 -X main.buildCodeVer=develop:fd84c07 -X main.buildConfVer=v1.1.16'"[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pktest/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/cmd/server/server" "/home/user00/cc/cc-slots-land/stage/app=pktest/app/bandit-server"[0m
[0;32mcopy theme collector data to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/themes/data" "/home/user00/cc/cc-slots-land/stage/app=pktest/app/data"[0m
[0;32mremove container: rpc-backend-builder[0m
[0;36mreclaim resources: rpc-backend-builder ee8dccc7e5c1[0m
ee8dccc7e5c1
ee8dccc7e5c1
[0;36mRPC_APP: pktest-rpc[0m
[0;36mIMAGE: plutus:pktest-rpc[0m
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  8.356MBSending build context to Docker daemon  17.27MBSending build context to Docker daemon  25.62MBSending build context to Docker daemon  33.98MBSending build context to Docker daemon  39.55MBSending build context to Docker daemon  45.12MBSending build context to Docker daemon  50.69MBSending build context to Docker daemon  57.93MBSending build context to Docker daemon  64.06MBSending build context to Docker daemon  70.75MBSending build context to Docker daemon  74.09MBSending build context to Docker daemon   79.1MBSending build context to Docker daemon  83.56MBSending build context to Docker daemon   90.8MBSending build context to Docker daemon   98.6MBSending build context to Docker daemon  106.4MBSending build context to Docker daemon  113.6MBSending build context to Docker daemon  120.9MBSending build context to Docker daemon    127MBSending build context to Docker daemon  134.3MBSending build context to Docker daemon  138.7MBSending build context to Docker daemon  147.1MBSending build context to Docker daemon  154.3MBSending build context to Docker daemon  162.1MBSending build context to Docker daemon  169.9MBSending build context to Docker daemon  177.1MBSending build context to Docker daemon  183.3MBSending build context to Docker daemon    190MBSending build context to Docker daemon  194.4MBSending build context to Docker daemon    200MBSending build context to Docker daemon    205MBSending build context to Docker daemon  212.2MBSending build context to Docker daemon    220MBSending build context to Docker daemon  227.8MBSending build context to Docker daemon  235.6MBSending build context to Docker daemon  243.4MBSending build context to Docker daemon  251.8MBSending build context to Docker daemon  260.1MBSending build context to Docker daemon  268.5MBSending build context to Docker daemon  275.7MBSending build context to Docker daemon  284.7MBSending build context to Docker daemon  291.3MBSending build context to Docker daemon  296.1MB
Step 1/6 : FROM alpine:3.14
 ---> dd53f409bf0b
Step 2/6 : RUN apk update 	&& apk add tzdata     && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime     && echo "Asia/Shanghai" >  /etc/timezone 	&& echo 'alias l="ls -ltA"' >> ~/.bashrc
 ---> Using cache
 ---> 5ad6219d23d9
Step 3/6 : ARG app
 ---> Using cache
 ---> 6128053649fb
Step 4/6 : ADD $app/app/ /slots
 ---> 24afe862dd1c
Step 5/6 : WORKDIR /slots
 ---> Running in 07c129b7a439
Removing intermediate container 07c129b7a439
 ---> 13203eb05d77
Step 6/6 : ENTRYPOINT ["/slots/bandit-server"]
 ---> Running in b030e4fef261
Removing intermediate container b030e4fef261
 ---> 6ba600d47555
Successfully built 6ba600d47555
Successfully tagged plutus:pktest-rpc
[0;32mgc: app=pktest/app/rpc[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pktest
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pktest/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pktest_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pktest_dev_bandit
[0;35m           Network:[0m pktest
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pktest-redis:6379
[0;35m Backend-Container:[0m pktest-backend
[1;33m  BANDIT-Container:[0m pktest-rpc
[0;32m Fluentd-Container:[0m pktest-fluentd
[0;32m   Mongo-Container:[0m pktest-mongo
[0;32m   Redis-Container:[0m pktest-redis

[0;32mstart pktest-rpc[0m
[0;36m  docker run -d     -e app=pktest.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pktest     -e sys_stage=dev_bandit     -e hostname=10.0.84.16     -e TZ=Asia/Shanghai     -e log_server_host=pktest-fluentd     -e log_server_port=24224     -e redis_uri=pktest-redis:6379     -e redis_passwd=     -e redis_db=0     -v /home/user00/cc/bandit-server/configs:/slots/configs/     -e panel_storage=/slots/data/gen/rawdata/panel_storage     --network pktest     --name pktest-rpc     plutus:pktest-rpc[0m
[0;36mreclaim resources: pktest-rpc d67632fb3b76[0m
d67632fb3b76
d67632fb3b76
fb67bf74e0782c8a2338ad8e505fd1a602e10e4dde1e485fd32d8e27b4ebf39c
2023-03-30 17:54:07.242530 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
/slots <nil>
configs/toml/dev.toml
configs {"RedisName":"","RedisEnableMonitor":true,"RedisAddrs":["127.0.0.1:6379"],"RedisDB":0,"RedisUsername":"","RedisPassword":"","RedisMaxRetries":3,"RedisMinRetryBackoff":8000000,"RedisMaxRetryBackoff":512000000,"RedisConnDialTimeout":5000000000,"RedisSocketReadTimeout":3000000000,"RedisSocketWriteTimeout":3000000000,"RedisConnPoolSize":0,"RedisMinIdleConns":0,"RedisConnMaxAge":0,"RedisConnPoolTimeout":0,"RedisIdleConnTimeout":300000000000,"RedisIdleConnCheckFrequency":60000000000,"RedisCluster":false,"RedisClusterReadOnly":false,"RedisClusterRouteRandomly":false,"RedisClusterRouteByLatency":false,"RedisMasterName":"","KeyTokenInHeader":"Authorization","AuthSchema":"Bearer","SigningKeys":["e!L7pH4y","aQSdp5x*","J@I1R\u0026Op"],"TokenExpiration":604800000000000,"ServerName":"bandit-server","ApiToken":"c1c61sff2hn00006gg2g","PassportUrl":"http://passport-dev-cn.ifunplus.cn:8000/server_api.php","PmConfPath":"/pkjy_dev","AutoConfFiles":"","DbAgentType":"mysql","MysqlPassword":"","MysqlHost":"127.0.0.1","DataServerHost":"127.0.0.1","MysqlUser":"root","MysqlDbName":"bandit-server","DbProxyEndpoints":null,"DbMaxOpenConns":20,"DbTimeout":3000000000,"DbMaxIdleConns":20,"MysqlPort":3306,"DataServerPort":3308,"EtcdEndpoint":["10.0.84.74:2379"],"MicroEtcdEndpoint":["127.0.0.1:2379"],"SiidUrl":"http://127.0.0.1:16000/v1/siid","IdTryTimes":3,"UseSiid":false,"TcpPort":8087,"TcpSendChanSize":1024,"OpenTcpGate":false,"HttpPort":8088,"HttpRateLimit":0,"OpenHttpGate":false,"PipelineEnable":false,"PipelineCacheExpiration":300000000000,"MonitorPort":9168,"PrometheusPort":9158,"ActorPort":9088,"RpcPort":8089,"Development":true,"OpenEtcd":false,"UseMysql":false,"UseRedis":false}
2023-03-30T17:54:07.247+0800	[35mdebug[0m	logbus/basic_logger.go:69	monitor	{"tags": ["monitor"], "log_xid": "cgilofs28456ut442i80", "server_id": "cgilofs28456ut442i60", "server_ip": "172.22.0.5", "server_birth": 1680170047, "host_name": "fb67bf74e078", "prometheus [http] listening on": ":9158", "path": "/metrics"}
2023-03-30T17:54:07.250+0800	[34minfo[0m	logbus/logger.go:103	server	{"tags": ["logbus"], "log_xid": "cgilofs28456ut442i90", "server_birth": 1680170047, "host_name": "fb67bf74e078", "server_tag": "bandit", "server_id": "c6ee30f3-8d00-4040-8097-01fa8dbf01b5", "server_ip": "172.22.0.5", "era": "2023-03-30T17:54:07+08:00", "code": " develop:fd84c07", "conf": "v1.1.16", "NumCPU": 8, "GOMAXPROCS": 8}
2023-03-30T17:54:07.252+0800	[34minfo[0m	sjaeger/log.go:19	server	{"tags": ["logbus"], "log_xid": "cgilofs28456ut442ia0", "server_birth": 1680170047, "host_name": "fb67bf74e078", "server_tag": "bandit", "server_id": "c6ee30f3-8d00-4040-8097-01fa8dbf01b5", "server_ip": "172.22.0.5", "era": "2023-03-30T17:54:07+08:00", "code": " develop:fd84c07", "conf": "v1.1.16", "glog-msg": "[sandwich jaeger] Initializing logging reporter\n"}
2023-03-30T17:54:07.253+0800	[33mwarn[0m	slog/slog.go:53	server	{"tags": ["logbus"], "log_xid": "cgilofs28456ut442ib0", "server_birth": 1680170047, "host_name": "fb67bf74e078", "server_tag": "bandit", "server_id": "c6ee30f3-8d00-4040-8097-01fa8dbf01b5", "server_ip": "172.22.0.5", "era": "2023-03-30T17:54:07+08:00", "code": " develop:fd84c07", "conf": "v1.1.16", "glog-msg": "[sandwich] [deprecated] should use WithAdapter to initialize pmconf package."}
2023-03-30T17:54:07.262+0800	[33mwarn[0m	slog/slog.go:53	server	{"tags": ["logbus"], "log_xid": "cgilofs28456ut442ic0", "server_birth": 1680170047, "host_name": "fb67bf74e078", "server_tag": "bandit", "server_id": "c6ee30f3-8d00-4040-8097-01fa8dbf01b5", "server_ip": "172.22.0.5", "era": "2023-03-30T17:54:07+08:00", "code": " develop:fd84c07", "conf": "v1.1.16", "glog-msg": "[sandwich] [deprecated] PmConfPath changed due to sys_env_name and sys_stage, should use sandwich_conf_env", "sysConfEnvStaging": "pktest_dev_bandit", "pm_conf_path": "/pktest_dev_bandit"}
PmConfPath = /pktest_dev_bandit/, ETCD endpoints = [10.0.84.16:2379]
etcd_endpoints = [10.0.84.16:2379]
./run_image_rpc.sh: line 45: jq: command not found
2023-03-30 17:54:07.242530 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pktest"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E5%8D%95%E7%8B%AC%E6%9B%B4%E6%96%B0RPC-Server/948/"

#!/bin/bash -e
source /root/jenkins/jk_func.sh
~/jenkins/analyze_log/analyze_err -url ${BUILD_URL}  || { echo "任务执行失败"; exit 1; }
sleep 5
check_whole_server $server_name

curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "text","text": {"content": "Jenkins-RPC-Server['"${server_name}"'] Restart OK"}}'
pktest-backend Check
pktest-rpc Check
pktest-redis Check
pktest-mongo Check
pktest-fluentd Check
{"errcode":0,"errmsg":"ok"}
[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
