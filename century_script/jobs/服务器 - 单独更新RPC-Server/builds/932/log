Started by user [8mha:////4HzE0KdkKUoEe3LZuhNgH6yc83P/GTxEBP+eXA1cZtU+AAAAmR+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAzOEgZe/dLi1CL9ksTMiszEfAA0j2PtwgAAAA==[0mhetaixiao
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 单独更新RPC-Server
[8mha:////4IDCXaTZegkMQ8N1ClLwTS6loaZDfBnwrV2V/rWJ32e8AAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGFaPEtBRzC+MU3TQjS3Ndk2TzRN2ktDQjXQtzYzPjJMvUpGTjVAClSrBWrwAAAA==[0m[SSH] executing pre build script:
server_name="pk7001"

#!/bin/bash 
source /root/jenkins/jk_func.sh

file_lock

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['bandit']")
rpc_port=$(yaml $conf_file "['$server_name']['rpc_port']")

cd /mnt/slots/bandit-server
git cd $branch_name
check_last_cmd branch

git pull
check_last_cmd pull

cd /mnt/slots/cc-slots-land/batch
./compile_rpc.sh $server_name && ./build_image_rpc.sh $server_name && ./run_image_rpc.sh $server_name $rpc_port

file_unlock
脚本可执行
{'bandit': 'bugfix/lavaCash_polish', 'game': 'develop', 'cc-conf': 'deploy-cc-conf', 'desc': 'pk7001', 'rpc_port': 7011, 'bandit-conf': 'deploy-bandit-conf', 'port': 7001}
Switched to branch 'bugfix/lavaCash_polish'
remote: Enumerating objects: 10, done.[K
remote: Counting objects:  10% (1/10)[Kremote: Counting objects:  20% (2/10)[Kremote: Counting objects:  30% (3/10)[Kremote: Counting objects:  40% (4/10)[Kremote: Counting objects:  50% (5/10)[Kremote: Counting objects:  60% (6/10)[Kremote: Counting objects:  70% (7/10)[Kremote: Counting objects:  80% (8/10)[Kremote: Counting objects:  90% (9/10)[Kremote: Counting objects: 100% (10/10)[Kremote: Counting objects: 100% (10/10), done.[K
remote: Compressing objects:  11% (1/9)[Kremote: Compressing objects:  22% (2/9)[Kremote: Compressing objects:  33% (3/9)[Kremote: Compressing objects:  44% (4/9)[Kremote: Compressing objects:  55% (5/9)[Kremote: Compressing objects:  66% (6/9)[Kremote: Compressing objects:  77% (7/9)[Kremote: Compressing objects:  88% (8/9)[Kremote: Compressing objects: 100% (9/9)[Kremote: Compressing objects: 100% (9/9), done.[K
remote: Total 10 (delta 0), reused 0 (delta 0), pack-reused 0[K
Unpacking objects:  10% (1/10)   Unpacking objects:  20% (2/10)   Unpacking objects:  30% (3/10)   Unpacking objects:  40% (4/10)   Unpacking objects:  50% (5/10)   Unpacking objects:  60% (6/10)   Unpacking objects:  70% (7/10)   Unpacking objects:  80% (8/10)   Unpacking objects:  90% (9/10)   Unpacking objects: 100% (10/10)   Unpacking objects: 100% (10/10), done.
From gitlab.funplus.io:fruities/bandit-server
   0af7d00..c18d20b  bugfix/lavaCash_polish -> origin/bugfix/lavaCash_polish
Updating 0af7d00..c18d20b
Fast-forward
 themes/cmd/lavaCash/simulation/simulation.go |  4 [32m++[m[31m--[m
 themes/game/lavaCash/config.go               | 18 [32m+++++++++[m[31m---------[m
 2 files changed, 11 insertions(+), 11 deletions(-)
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7001
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7001/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7001_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7001_dev_bandit
[0;35m           Network:[0m pk7001
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7001-redis:6379
[0;35m Backend-Container:[0m pk7001-backend
[1;33m  BANDIT-Container:[0m pk7001-rpc
[0;32m Fluentd-Container:[0m pk7001-fluentd
[0;32m   Mongo-Container:[0m pk7001-mongo
[0;32m   Redis-Container:[0m pk7001-redis
[1;33m            DATE:[0m 2023-03-27T17:23:52+0800
[1;33m   BUILD COMMAND:[0m cd bandit-server/cmd/server && go build -ldflags '-X main.buildTime=2023-03-27T17:23:52+0800 -X main.buildCodeVer=bugfix/lavaCash_polish:c18d20b -X main.buildConfVer=v1.1.16'
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m rpc-backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/bandit-server bugfix/lavaCash_polish:c18d20b
[1;33m        CONF_DIR:[0m /home/user00/cc/bandit-conf v1.1.16
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pk7001/config.ini
[1;33mCONFIG_FILE_PROD:[0m pk7001/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "rpc-backend-builder"   --hostname "rpc-backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/bandit-server":"/slots/bandit-server"   -v "/home/user00/cc/bandit-conf":"/slots/bandit-conf"   -v "/home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd bandit-server/cmd/server && go build -ldflags '-X main.buildTime=2023-03-27T17:23:52+0800 -X main.buildCodeVer=bugfix/lavaCash_polish:c18d20b -X main.buildConfVer=v1.1.16'"[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pk7001/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/cmd/server/server" "/home/user00/cc/cc-slots-land/stage/app=pk7001/app/bandit-server"[0m
[0;32mcopy theme collector data to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/themes/data" "/home/user00/cc/cc-slots-land/stage/app=pk7001/app/data"[0m
[0;32mremove container: rpc-backend-builder[0m
[0;36mreclaim resources: rpc-backend-builder 2f71664de74d[0m
2f71664de74d
2f71664de74d
[0;36mRPC_APP: pk7001-rpc[0m
[0;36mIMAGE: plutus:pk7001-rpc[0m
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  7.242MBSending build context to Docker daemon  12.81MBSending build context to Docker daemon  18.94MBSending build context to Docker daemon   27.3MBSending build context to Docker daemon  33.98MBSending build context to Docker daemon  42.34MBSending build context to Docker daemon  51.25MBSending build context to Docker daemon  57.38MBSending build context to Docker daemon  64.06MBSending build context to Docker daemon  72.42MBSending build context to Docker daemon  80.22MBSending build context to Docker daemon  86.34MBSending build context to Docker daemon  94.14MBSending build context to Docker daemon  99.16MBSending build context to Docker daemon  104.2MBSending build context to Docker daemon  110.9MBSending build context to Docker daemon  118.7MBSending build context to Docker daemon  125.3MBSending build context to Docker daemon  130.9MBSending build context to Docker daemon  135.9MBSending build context to Docker daemon  142.6MBSending build context to Docker daemon  148.7MBSending build context to Docker daemon  156.5MBSending build context to Docker daemon  164.3MBSending build context to Docker daemon  171.6MBSending build context to Docker daemon  179.9MBSending build context to Docker daemon  187.2MBSending build context to Docker daemon  193.3MBSending build context to Docker daemon    200MBSending build context to Docker daemon  204.4MBSending build context to Docker daemon  208.9MBSending build context to Docker daemon  213.4MBSending build context to Docker daemon  216.1MBSending build context to Docker daemon  217.3MBSending build context to Docker daemon    220MBSending build context to Docker daemon  221.2MBSending build context to Docker daemon  223.4MBSending build context to Docker daemon  225.6MBSending build context to Docker daemon  227.3MBSending build context to Docker daemon    229MBSending build context to Docker daemon  230.6MBSending build context to Docker daemon  232.3MBSending build context to Docker daemon  233.4MBSending build context to Docker daemon  235.6MBSending build context to Docker daemon  237.9MBSending build context to Docker daemon  241.8MBSending build context to Docker daemon  246.2MBSending build context to Docker daemon  249.6MBSending build context to Docker daemon  256.2MBSending build context to Docker daemon    264MBSending build context to Docker daemon  271.8MBSending build context to Docker daemon  280.2MBSending build context to Docker daemon  289.1MBSending build context to Docker daemon    296MB
Step 1/6 : FROM alpine:3.14
 ---> dd53f409bf0b
Step 2/6 : RUN apk update 	&& apk add tzdata     && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime     && echo "Asia/Shanghai" >  /etc/timezone 	&& echo 'alias l="ls -ltA"' >> ~/.bashrc
 ---> Using cache
 ---> 5ad6219d23d9
Step 3/6 : ARG app
 ---> Using cache
 ---> 6128053649fb
Step 4/6 : ADD $app/app/ /slots
 ---> e3d4b9ba801a
Step 5/6 : WORKDIR /slots
 ---> Running in 22b783ac9faf
Removing intermediate container 22b783ac9faf
 ---> b8768c126c42
Step 6/6 : ENTRYPOINT ["/slots/bandit-server"]
 ---> Running in b120d2d3ded7
Removing intermediate container b120d2d3ded7
 ---> 4533c925be48
Successfully built 4533c925be48
Successfully tagged plutus:pk7001-rpc
[0;32mgc: app=pk7001/app/rpc[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7001
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7001/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7001_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7001_dev_bandit
[0;35m           Network:[0m pk7001
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7001-redis:6379
[0;35m Backend-Container:[0m pk7001-backend
[1;33m  BANDIT-Container:[0m pk7001-rpc
[0;32m Fluentd-Container:[0m pk7001-fluentd
[0;32m   Mongo-Container:[0m pk7001-mongo
[0;32m   Redis-Container:[0m pk7001-redis

[0;32mstart pk7001-rpc[0m
[0;36m  docker run -d     -e app=pk7001.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pk7001     -e sys_stage=dev_bandit     -e hostname=10.0.84.16     -e TZ=Asia/Shanghai     -e log_server_host=pk7001-fluentd     -e log_server_port=24224     -e redis_uri=pk7001-redis:6379     -e redis_passwd=     -e redis_db=0     -v /home/user00/cc/bandit-server/configs:/slots/configs/     -e panel_storage=/slots/data/gen/rawdata/panel_storage     --network pk7001     --name pk7001-rpc     plutus:pk7001-rpc[0m
[0;36mreclaim resources: pk7001-rpc c6c9e9767ed3[0m
c6c9e9767ed3
c6c9e9767ed3
53954f795933d4be8adbb42dc1a4f0c13179de6cc7157e081fc619820edea397
2023-03-27 17:24:54.617394 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
/slots <nil>
configs/toml/dev.toml
configs {"RedisName":"","RedisEnableMonitor":true,"RedisAddrs":["127.0.0.1:6379"],"RedisDB":0,"RedisUsername":"","RedisPassword":"","RedisMaxRetries":3,"RedisMinRetryBackoff":8000000,"RedisMaxRetryBackoff":512000000,"RedisConnDialTimeout":5000000000,"RedisSocketReadTimeout":3000000000,"RedisSocketWriteTimeout":3000000000,"RedisConnPoolSize":0,"RedisMinIdleConns":0,"RedisConnMaxAge":0,"RedisConnPoolTimeout":0,"RedisIdleConnTimeout":300000000000,"RedisIdleConnCheckFrequency":60000000000,"RedisCluster":false,"RedisClusterReadOnly":false,"RedisClusterRouteRandomly":false,"RedisClusterRouteByLatency":false,"RedisMasterName":"","KeyTokenInHeader":"Authorization","AuthSchema":"Bearer","SigningKeys":["e!L7pH4y","aQSdp5x*","J@I1R\u0026Op"],"TokenExpiration":604800000000000,"ServerName":"bandit-server","ApiToken":"c1c61sff2hn00006gg2g","PassportUrl":"http://passport-dev-cn.ifunplus.cn:8000/server_api.php","PmConfPath":"/pkjy_dev","AutoConfFiles":"","DbAgentType":"mysql","MysqlPassword":"","MysqlHost":"127.0.0.1","DataServerHost":"127.0.0.1","MysqlUser":"root","MysqlDbName":"bandit-server","DbProxyEndpoints":null,"DbMaxOpenConns":20,"DbTimeout":3000000000,"DbMaxIdleConns":20,"MysqlPort":3306,"DataServerPort":3308,"EtcdEndpoint":["10.0.84.74:2379"],"MicroEtcdEndpoint":["127.0.0.1:2379"],"SiidUrl":"http://127.0.0.1:16000/v1/siid","IdTryTimes":3,"UseSiid":false,"TcpPort":8087,"TcpSendChanSize":1024,"OpenTcpGate":false,"HttpPort":8088,"HttpRateLimit":0,"OpenHttpGate":false,"PipelineEnable":false,"PipelineCacheExpiration":300000000000,"MonitorPort":9168,"PrometheusPort":9158,"ActorPort":9088,"RpcPort":8089,"Development":true,"OpenEtcd":false,"UseMysql":false,"UseRedis":false}
2023-03-27T17:24:54.622+0800	[35mdebug[0m	logbus/basic_logger.go:69	monitor	{"tags": ["monitor"], "log_xid": "cggm1pk28454bnhnvad0", "server_id": "cggm1pk28454bnhnvab0", "server_ip": "172.27.0.5", "server_birth": 1679909094, "host_name": "53954f795933", "prometheus [http] listening on": ":9158", "path": "/metrics"}
2023-03-27T17:24:54.622+0800	[34minfo[0m	logbus/logger.go:103	server	{"tags": ["logbus"], "log_xid": "cggm1pk28454bnhnvae0", "server_birth": 1679909094, "host_name": "53954f795933", "server_tag": "bandit", "server_id": "8ab16ab1-6c38-4535-8a67-04b443a446cc", "server_ip": "172.27.0.5", "era": "2023-03-27T17:24:54+08:00", "code": " bugfix/lavaCash_polish:c18d20b", "conf": "v1.1.16", "NumCPU": 8, "GOMAXPROCS": 8}
2023-03-27T17:24:54.623+0800	[34minfo[0m	sjaeger/log.go:19	server	{"tags": ["logbus"], "log_xid": "cggm1pk28454bnhnvaf0", "server_birth": 1679909094, "host_name": "53954f795933", "server_tag": "bandit", "server_id": "8ab16ab1-6c38-4535-8a67-04b443a446cc", "server_ip": "172.27.0.5", "era": "2023-03-27T17:24:54+08:00", "code": " bugfix/lavaCash_polish:c18d20b", "conf": "v1.1.16", "glog-msg": "[sandwich jaeger] Initializing logging reporter\n"}
2023-03-27T17:24:54.624+0800	[33mwarn[0m	slog/slog.go:53	server	{"tags": ["logbus"], "log_xid": "cggm1pk28454bnhnvag0", "server_birth": 1679909094, "host_name": "53954f795933", "server_tag": "bandit", "server_id": "8ab16ab1-6c38-4535-8a67-04b443a446cc", "server_ip": "172.27.0.5", "era": "2023-03-27T17:24:54+08:00", "code": " bugfix/lavaCash_polish:c18d20b", "conf": "v1.1.16", "glog-msg": "[sandwich] [deprecated] should use WithAdapter to initialize pmconf package."}
2023-03-27T17:24:54.631+0800	[33mwarn[0m	slog/slog.go:53	server	{"tags": ["logbus"], "log_xid": "cggm1pk28454bnhnvah0", "server_birth": 1679909094, "host_name": "53954f795933", "server_tag": "bandit", "server_id": "8ab16ab1-6c38-4535-8a67-04b443a446cc", "server_ip": "172.27.0.5", "era": "2023-03-27T17:24:54+08:00", "code": " bugfix/lavaCash_polish:c18d20b", "conf": "v1.1.16", "glog-msg": "[sandwich] [deprecated] PmConfPath changed due to sys_env_name and sys_stage, should use sandwich_conf_env", "sysConfEnvStaging": "pk7001_dev_bandit", "pm_conf_path": "/pk7001_dev_bandit"}
PmConfPath = /pk7001_dev_bandit/, ETCD endpoints = [10.0.84.16:2379]
etcd_endpoints = [10.0.84.16:2379]
./run_image_rpc.sh: line 45: jq: command not found
2023-03-27 17:24:54.617394 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pk7001"

source /root/jenkins/jk_func.sh
sleep 5
check_whole_server $server_name

curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "text","text": {"content": "Jenkins-RPC-Server['"${server_name}"'] Restart OK"}}'
pk7001-backend Check
pk7001-rpc Check
pk7001-redis Check
pk7001-mongo Check
pk7001-fluentd Check
{"errcode":0,"errmsg":"ok"}
[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
