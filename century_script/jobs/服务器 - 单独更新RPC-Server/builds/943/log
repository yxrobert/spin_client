Started by user [8mha:////4HzE0KdkKUoEe3LZuhNgH6yc83P/GTxEBP+eXA1cZtU+AAAAmR+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAzOEgZe/dLi1CL9ksTMiszEfAA0j2PtwgAAAA==[0mhetaixiao
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 单独更新RPC-Server
[8mha:////4F+cf5X5cTFQA2OeXWLQz2zOyGK4qjck+LNgIftlp7TRAAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGFcO05CTjZCMzXfM0QwNdE2MjA12L5KREXRPD1FQL82QzszTjRADfd9VjrwAAAA==[0m[SSH] executing pre build script:
server_name="pktest"

#!/bin/bash 
source /root/jenkins/jk_func.sh

if [ -z "$server_name" ]; then
    echo "Error: 没有选择服务器!"
    exit 1
fi

file_lock

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['bandit']")
rpc_port=$(yaml $conf_file "['$server_name']['rpc_port']")

cd /mnt/slots/bandit-server
git cd $branch_name
check_last_cmd branch

git pull
check_last_cmd pull

cd /mnt/slots/cc-slots-land/batch
./compile_rpc.sh $server_name && ./build_image_rpc.sh $server_name && ./run_image_rpc.sh $server_name $rpc_port

file_unlock
脚本可执行
{'bandit': 'develop', 'game': 'develop', 'cc-conf': 'deploy-cc-conf', 'desc': 'pktest', 'rpc_port': 6676, 'bandit-conf': 'deploy-bandit-conf', 'port': 6666}
Already on 'develop'
remote: Enumerating objects: 26, done.[K
remote: Counting objects:   3% (1/26)[Kremote: Counting objects:   7% (2/26)[Kremote: Counting objects:  11% (3/26)[Kremote: Counting objects:  15% (4/26)[Kremote: Counting objects:  19% (5/26)[Kremote: Counting objects:  23% (6/26)[Kremote: Counting objects:  26% (7/26)[Kremote: Counting objects:  30% (8/26)[Kremote: Counting objects:  34% (9/26)[Kremote: Counting objects:  38% (10/26)[Kremote: Counting objects:  42% (11/26)[Kremote: Counting objects:  46% (12/26)[Kremote: Counting objects:  50% (13/26)[Kremote: Counting objects:  53% (14/26)[Kremote: Counting objects:  57% (15/26)[Kremote: Counting objects:  61% (16/26)[Kremote: Counting objects:  65% (17/26)[Kremote: Counting objects:  69% (18/26)[Kremote: Counting objects:  73% (19/26)[Kremote: Counting objects:  76% (20/26)[Kremote: Counting objects:  80% (21/26)[Kremote: Counting objects:  84% (22/26)[Kremote: Counting objects:  88% (23/26)[Kremote: Counting objects:  92% (24/26)[Kremote: Counting objects:  96% (25/26)[Kremote: Counting objects: 100% (26/26)[Kremote: Counting objects: 100% (26/26), done.[K
remote: Compressing objects:   4% (1/25)[Kremote: Compressing objects:   8% (2/25)[Kremote: Compressing objects:  12% (3/25)[Kremote: Compressing objects:  16% (4/25)[Kremote: Compressing objects:  20% (5/25)[Kremote: Compressing objects:  24% (6/25)[Kremote: Compressing objects:  28% (7/25)[Kremote: Compressing objects:  32% (8/25)[Kremote: Compressing objects:  36% (9/25)[Kremote: Compressing objects:  40% (10/25)[Kremote: Compressing objects:  44% (11/25)[Kremote: Compressing objects:  48% (12/25)[Kremote: Compressing objects:  52% (13/25)[Kremote: Compressing objects:  56% (14/25)[Kremote: Compressing objects:  60% (15/25)[Kremote: Compressing objects:  64% (16/25)[Kremote: Compressing objects:  68% (17/25)[Kremote: Compressing objects:  72% (18/25)[Kremote: Compressing objects:  76% (19/25)[Kremote: Compressing objects:  80% (20/25)[Kremote: Compressing objects:  84% (21/25)[Kremote: Compressing objects:  88% (22/25)[Kremote: Compressing objects:  92% (23/25)[Kremote: Compressing objects:  96% (24/25)[Kremote: Compressing objects: 100% (25/25)[Kremote: Compressing objects: 100% (25/25), done.[K
remote: Total 26 (delta 7), reused 0 (delta 0), pack-reused 0[K
Unpacking objects:   3% (1/26)   Unpacking objects:   7% (2/26)   Unpacking objects:  11% (3/26)   Unpacking objects:  15% (4/26)   Unpacking objects:  19% (5/26)   Unpacking objects:  23% (6/26)   Unpacking objects:  26% (7/26)   Unpacking objects:  30% (8/26)   Unpacking objects:  34% (9/26)   Unpacking objects:  38% (10/26)   Unpacking objects:  42% (11/26)   Unpacking objects:  46% (12/26)   Unpacking objects:  50% (13/26)   Unpacking objects:  53% (14/26)   Unpacking objects:  57% (15/26)   Unpacking objects:  61% (16/26)   Unpacking objects:  65% (17/26)   Unpacking objects:  69% (18/26)   Unpacking objects:  73% (19/26)   Unpacking objects:  76% (20/26)   Unpacking objects:  80% (21/26)   Unpacking objects:  84% (22/26)   Unpacking objects:  88% (23/26)   Unpacking objects:  92% (24/26)   Unpacking objects:  96% (25/26)   Unpacking objects: 100% (26/26)   Unpacking objects: 100% (26/26), done.
From gitlab.funplus.io:fruities/bandit-server
   bafefac..412c8e3  develop    -> origin/develop
   82e99e5..825b518  bugfix/lavaCash_polish -> origin/bugfix/lavaCash_polish
Updating bafefac..412c8e3
Fast-forward
 themes/game/penguinHammer/config.go         |  2 [32m+[m[31m-[m
 themes/game/penguinHammer/game.go           |  5 [32m++[m[31m-[m
 themes/game/penguinHammer/gameBonus.go      | 54 [32m+++++++++++++++++++++++++++++[m
 themes/game/penguinHammer/gameTrainBonus.go |  5 [32m++[m[31m-[m
 4 files changed, 63 insertions(+), 3 deletions(-)
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pktest
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pktest/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pktest_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pktest_dev_bandit
[0;35m           Network:[0m pktest
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pktest-redis:6379
[0;35m Backend-Container:[0m pktest-backend
[1;33m  BANDIT-Container:[0m pktest-rpc
[0;32m Fluentd-Container:[0m pktest-fluentd
[0;32m   Mongo-Container:[0m pktest-mongo
[0;32m   Redis-Container:[0m pktest-redis
[1;33m            DATE:[0m 2023-03-29T11:44:29+0800
[1;33m   BUILD COMMAND:[0m cd bandit-server/cmd/server && go build -ldflags '-X main.buildTime=2023-03-29T11:44:29+0800 -X main.buildCodeVer=develop:412c8e3 -X main.buildConfVer=v1.1.16'
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m rpc-backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/bandit-server develop:412c8e3
[1;33m        CONF_DIR:[0m /home/user00/cc/bandit-conf v1.1.16
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pktest/config.ini
[1;33mCONFIG_FILE_PROD:[0m pktest/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "rpc-backend-builder"   --hostname "rpc-backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/bandit-server":"/slots/bandit-server"   -v "/home/user00/cc/bandit-conf":"/slots/bandit-conf"   -v "/home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd bandit-server/cmd/server && go build -ldflags '-X main.buildTime=2023-03-29T11:44:29+0800 -X main.buildCodeVer=develop:412c8e3 -X main.buildConfVer=v1.1.16'"[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pktest/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/cmd/server/server" "/home/user00/cc/cc-slots-land/stage/app=pktest/app/bandit-server"[0m
[0;32mcopy theme collector data to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/themes/data" "/home/user00/cc/cc-slots-land/stage/app=pktest/app/data"[0m
[0;32mremove container: rpc-backend-builder[0m
[0;36mreclaim resources: rpc-backend-builder d6b3a28f41de[0m
d6b3a28f41de
d6b3a28f41de
[0;36mRPC_APP: pktest-rpc[0m
[0;36mIMAGE: plutus:pktest-rpc[0m
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  8.356MBSending build context to Docker daemon   15.6MBSending build context to Docker daemon  22.84MBSending build context to Docker daemon  30.08MBSending build context to Docker daemon  37.32MBSending build context to Docker daemon  44.56MBSending build context to Docker daemon  52.36MBSending build context to Docker daemon  60.16MBSending build context to Docker daemon  68.52MBSending build context to Docker daemon  75.76MBSending build context to Docker daemon  84.12MBSending build context to Docker daemon  91.91MBSending build context to Docker daemon  99.71MBSending build context to Docker daemon  107.5MBSending build context to Docker daemon  112.5MBSending build context to Docker daemon  118.1MBSending build context to Docker daemon  124.2MBSending build context to Docker daemon  131.5MBSending build context to Docker daemon  136.5MBSending build context to Docker daemon  143.7MBSending build context to Docker daemon  151.5MBSending build context to Docker daemon  159.9MBSending build context to Docker daemon  167.7MBSending build context to Docker daemon  175.5MBSending build context to Docker daemon  183.8MBSending build context to Docker daemon  191.1MBSending build context to Docker daemon  198.3MBSending build context to Docker daemon  206.1MBSending build context to Docker daemon  213.9MBSending build context to Docker daemon  222.8MBSending build context to Docker daemon  231.2MBSending build context to Docker daemon  238.4MBSending build context to Docker daemon  246.2MBSending build context to Docker daemon    254MBSending build context to Docker daemon  260.7MBSending build context to Docker daemon  269.1MBSending build context to Docker daemon  274.6MBSending build context to Docker daemon  281.3MBSending build context to Docker daemon  289.1MBSending build context to Docker daemon    296MB
Step 1/6 : FROM alpine:3.14
 ---> dd53f409bf0b
Step 2/6 : RUN apk update 	&& apk add tzdata     && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime     && echo "Asia/Shanghai" >  /etc/timezone 	&& echo 'alias l="ls -ltA"' >> ~/.bashrc
 ---> Using cache
 ---> 5ad6219d23d9
Step 3/6 : ARG app
 ---> Using cache
 ---> 6128053649fb
Step 4/6 : ADD $app/app/ /slots
 ---> 9ecb70ae4ecc
Step 5/6 : WORKDIR /slots
 ---> Running in c51f651584d8
Removing intermediate container c51f651584d8
 ---> 4ca0ab521921
Step 6/6 : ENTRYPOINT ["/slots/bandit-server"]
 ---> Running in 482110b949cd
Removing intermediate container 482110b949cd
 ---> 60f9a7bbf16f
Successfully built 60f9a7bbf16f
Successfully tagged plutus:pktest-rpc
[0;32mgc: app=pktest/app/rpc[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pktest
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pktest/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pktest/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pktest_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pktest_dev_bandit
[0;35m           Network:[0m pktest
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pktest-redis:6379
[0;35m Backend-Container:[0m pktest-backend
[1;33m  BANDIT-Container:[0m pktest-rpc
[0;32m Fluentd-Container:[0m pktest-fluentd
[0;32m   Mongo-Container:[0m pktest-mongo
[0;32m   Redis-Container:[0m pktest-redis

[0;32mstart pktest-rpc[0m
[0;36m  docker run -d     -e app=pktest.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pktest     -e sys_stage=dev_bandit     -e hostname=10.0.84.16     -e TZ=Asia/Shanghai     -e log_server_host=pktest-fluentd     -e log_server_port=24224     -e redis_uri=pktest-redis:6379     -e redis_passwd=     -e redis_db=0     -v /home/user00/cc/bandit-server/configs:/slots/configs/     -e panel_storage=/slots/data/gen/rawdata/panel_storage     --network pktest     --name pktest-rpc     plutus:pktest-rpc[0m
[0;36mreclaim resources: pktest-rpc a11deeb37450[0m
a11deeb37450
a11deeb37450
4f5aad291b3c5fcded2208bdb0c00209d0a1e81418a82f5ee62dc72377b4ce72
2023-03-29 11:45:37.249739 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
/slots <nil>
configs/toml/dev.toml
configs {"RedisName":"","RedisEnableMonitor":true,"RedisAddrs":["127.0.0.1:6379"],"RedisDB":0,"RedisUsername":"","RedisPassword":"","RedisMaxRetries":3,"RedisMinRetryBackoff":8000000,"RedisMaxRetryBackoff":512000000,"RedisConnDialTimeout":5000000000,"RedisSocketReadTimeout":3000000000,"RedisSocketWriteTimeout":3000000000,"RedisConnPoolSize":0,"RedisMinIdleConns":0,"RedisConnMaxAge":0,"RedisConnPoolTimeout":0,"RedisIdleConnTimeout":300000000000,"RedisIdleConnCheckFrequency":60000000000,"RedisCluster":false,"RedisClusterReadOnly":false,"RedisClusterRouteRandomly":false,"RedisClusterRouteByLatency":false,"RedisMasterName":"","KeyTokenInHeader":"Authorization","AuthSchema":"Bearer","SigningKeys":["e!L7pH4y","aQSdp5x*","J@I1R\u0026Op"],"TokenExpiration":604800000000000,"ServerName":"bandit-server","ApiToken":"c1c61sff2hn00006gg2g","PassportUrl":"http://passport-dev-cn.ifunplus.cn:8000/server_api.php","PmConfPath":"/pkjy_dev","AutoConfFiles":"","DbAgentType":"mysql","MysqlPassword":"","MysqlHost":"127.0.0.1","DataServerHost":"127.0.0.1","MysqlUser":"root","MysqlDbName":"bandit-server","DbProxyEndpoints":null,"DbMaxOpenConns":20,"DbTimeout":3000000000,"DbMaxIdleConns":20,"MysqlPort":3306,"DataServerPort":3308,"EtcdEndpoint":["10.0.84.74:2379"],"MicroEtcdEndpoint":["127.0.0.1:2379"],"SiidUrl":"http://127.0.0.1:16000/v1/siid","IdTryTimes":3,"UseSiid":false,"TcpPort":8087,"TcpSendChanSize":1024,"OpenTcpGate":false,"HttpPort":8088,"HttpRateLimit":0,"OpenHttpGate":false,"PipelineEnable":false,"PipelineCacheExpiration":300000000000,"MonitorPort":9168,"PrometheusPort":9158,"ActorPort":9088,"RpcPort":8089,"Development":true,"OpenEtcd":false,"UseMysql":false,"UseRedis":false}
2023-03-29T11:45:37.254+0800	[35mdebug[0m	logbus/basic_logger.go:69	monitor	{"tags": ["monitor"], "log_xid": "cghr8oc28456k12qqr80", "server_id": "cghr8oc28456k12qqr60", "server_ip": "172.22.0.5", "server_birth": 1680061537, "host_name": "4f5aad291b3c", "prometheus [http] listening on": ":9158", "path": "/metrics"}
2023-03-29T11:45:37.255+0800	[34minfo[0m	logbus/logger.go:103	server	{"tags": ["logbus"], "log_xid": "cghr8oc28456k12qqr90", "server_birth": 1680061537, "host_name": "4f5aad291b3c", "server_tag": "bandit", "server_id": "bb9e664f-6125-46cb-a2b4-453af764169d", "server_ip": "172.22.0.5", "era": "2023-03-29T11:45:37+08:00", "code": " develop:412c8e3", "conf": "v1.1.16", "NumCPU": 8, "GOMAXPROCS": 8}
2023-03-29T11:45:37.257+0800	[34minfo[0m	sjaeger/log.go:19	server	{"tags": ["logbus"], "log_xid": "cghr8oc28456k12qqra0", "server_birth": 1680061537, "host_name": "4f5aad291b3c", "server_tag": "bandit", "server_id": "bb9e664f-6125-46cb-a2b4-453af764169d", "server_ip": "172.22.0.5", "era": "2023-03-29T11:45:37+08:00", "code": " develop:412c8e3", "conf": "v1.1.16", "glog-msg": "[sandwich jaeger] Initializing logging reporter\n"}
2023-03-29T11:45:37.257+0800	[33mwarn[0m	slog/slog.go:53	server	{"tags": ["logbus"], "log_xid": "cghr8oc28456k12qqrb0", "server_birth": 1680061537, "host_name": "4f5aad291b3c", "server_tag": "bandit", "server_id": "bb9e664f-6125-46cb-a2b4-453af764169d", "server_ip": "172.22.0.5", "era": "2023-03-29T11:45:37+08:00", "code": " develop:412c8e3", "conf": "v1.1.16", "glog-msg": "[sandwich] [deprecated] should use WithAdapter to initialize pmconf package."}
2023-03-29T11:45:37.260+0800	[33mwarn[0m	slog/slog.go:53	server	{"tags": ["logbus"], "log_xid": "cghr8oc28456k12qqrc0", "server_birth": 1680061537, "host_name": "4f5aad291b3c", "server_tag": "bandit", "server_id": "bb9e664f-6125-46cb-a2b4-453af764169d", "server_ip": "172.22.0.5", "era": "2023-03-29T11:45:37+08:00", "code": " develop:412c8e3", "conf": "v1.1.16", "glog-msg": "[sandwich] [deprecated] PmConfPath changed due to sys_env_name and sys_stage, should use sandwich_conf_env", "sysConfEnvStaging": "pktest_dev_bandit", "pm_conf_path": "/pktest_dev_bandit"}
PmConfPath = /pktest_dev_bandit/, ETCD endpoints = [10.0.84.16:2379]
etcd_endpoints = [10.0.84.16:2379]
./run_image_rpc.sh: line 45: jq: command not found
2023-03-29 11:45:37.249739 I | maxprocs: Leaving GOMAXPROCS=8: CPU quota undefined
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pktest"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E5%8D%95%E7%8B%AC%E6%9B%B4%E6%96%B0RPC-Server/943/"

source /root/jenkins/jk_func.sh
~/jenkins/analyze_log/analyze_err -url ${BUILD_URL}
sleep 5
check_whole_server $server_name

curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "text","text": {"content": "Jenkins-RPC-Server['"${server_name}"'] Restart OK"}}'
pktest-backend Check
pktest-rpc Check
pktest-redis Check
pktest-mongo Check
pktest-fluentd Check
{"errcode":0,"errmsg":"ok"}
[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
