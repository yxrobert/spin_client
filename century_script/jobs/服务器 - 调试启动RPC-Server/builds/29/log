Started by user [8mha:////4HzE0KdkKUoEe3LZuhNgH6yc83P/GTxEBP+eXA1cZtU+AAAAmR+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAzOEgZe/dLi1CL9ksTMiszEfAA0j2PtwgAAAA==[0mhetaixiao
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 调试启动RPC-Server
[8mha:////4IINaFuoXNafui301sHvzKoah9wLUuuwd1k6Pp8kbkH8AAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGlWRL42QLAwtTXfM0MxNdE6PkFN2kFAMjXVOLJLPU1GTTRIOkRACAXsK0rwAAAA==[0m[SSH] executing pre build script:
server_name="pk7001"

#!/bin/bash 
source /root/jenkins/jk_func.sh

file_lock

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['bandit']")
rpc_port=$(yaml $conf_file "['$server_name']['rpc_port']")

cd /mnt/slots/bandit-server
git cd $branch_name
check_last_cmd branch

git pull
check_last_cmd pull

cd /mnt/slots/cc-slots-land/batch
git checkout feature/jenkins

./compile_rpc_gdb.sh $server_name && ./build_image_rpc_gdb.sh $server_name && ./run_image_rpc_gdb.sh $server_name $rpc_port

cd /mnt/slots/cc-slots-land/batch
git checkout master
file_unlock
脚本可执行
{'bandit': 'bugfix/lavaCash_polish', 'game': 'develop', 'cc-conf': 'deploy-cc-conf', 'desc': 'pk7001', 'rpc_port': 7011, 'bandit-conf': 'deploy-bandit-conf', 'port': 7001}
Switched to branch 'bugfix/lavaCash_polish'
Your branch is behind 'origin/bugfix/lavaCash_polish' by 3 commits, and can be fast-forwarded.
  (use "git pull" to update your local branch)
remote: Enumerating objects: 18, done.[K
remote: Counting objects:   5% (1/18)[Kremote: Counting objects:  11% (2/18)[Kremote: Counting objects:  16% (3/18)[Kremote: Counting objects:  22% (4/18)[Kremote: Counting objects:  27% (5/18)[Kremote: Counting objects:  33% (6/18)[Kremote: Counting objects:  38% (7/18)[Kremote: Counting objects:  44% (8/18)[Kremote: Counting objects:  50% (9/18)[Kremote: Counting objects:  55% (10/18)[Kremote: Counting objects:  61% (11/18)[Kremote: Counting objects:  66% (12/18)[Kremote: Counting objects:  72% (13/18)[Kremote: Counting objects:  77% (14/18)[Kremote: Counting objects:  83% (15/18)[Kremote: Counting objects:  88% (16/18)[Kremote: Counting objects:  94% (17/18)[Kremote: Counting objects: 100% (18/18)[Kremote: Counting objects: 100% (18/18), done.[K
remote: Compressing objects:   5% (1/18)[Kremote: Compressing objects:  11% (2/18)[Kremote: Compressing objects:  16% (3/18)[Kremote: Compressing objects:  22% (4/18)[Kremote: Compressing objects:  27% (5/18)[Kremote: Compressing objects:  33% (6/18)[Kremote: Compressing objects:  38% (7/18)[Kremote: Compressing objects:  44% (8/18)[Kremote: Compressing objects:  50% (9/18)[Kremote: Compressing objects:  55% (10/18)[Kremote: Compressing objects:  61% (11/18)[Kremote: Compressing objects:  66% (12/18)[Kremote: Compressing objects:  72% (13/18)[Kremote: Compressing objects:  77% (14/18)[Kremote: Compressing objects:  83% (15/18)[Kremote: Compressing objects:  88% (16/18)[Kremote: Compressing objects:  94% (17/18)[Kremote: Compressing objects: 100% (18/18)[Kremote: Compressing objects: 100% (18/18), done.[K
remote: Total 18 (delta 3), reused 0 (delta 0), pack-reused 0[K
Unpacking objects:   5% (1/18)   Unpacking objects:  11% (2/18)   Unpacking objects:  16% (3/18)   Unpacking objects:  22% (4/18)   Unpacking objects:  27% (5/18)   Unpacking objects:  33% (6/18)   Unpacking objects:  38% (7/18)   Unpacking objects:  44% (8/18)   Unpacking objects:  50% (9/18)   Unpacking objects:  55% (10/18)   Unpacking objects:  61% (11/18)   Unpacking objects:  66% (12/18)   Unpacking objects:  72% (13/18)   Unpacking objects:  77% (14/18)   Unpacking objects:  83% (15/18)   Unpacking objects:  88% (16/18)   Unpacking objects:  94% (17/18)   Unpacking objects: 100% (18/18)   Unpacking objects: 100% (18/18), done.
From gitlab.funplus.io:fruities/bandit-server
   825b518..dfd3687  bugfix/lavaCash_polish -> origin/bugfix/lavaCash_polish
   a36661b..a277490  feature/zhaoCaiJinBao-legend -> origin/feature/zhaoCaiJinBao-legend
Updating 983cf07..dfd3687
Fast-forward
 themes/cmd/lavaCash/madEx/madEx.go |  2 [32m+[m[31m-[m
 themes/game/lavaCash/config.go     | 68 [32m+++++++++++++++++++++++[m[31m---------------[m
 themes/game/lavaCash/game.go       | 26 [32m+++++++++++++[m[31m--[m
 themes/game/lavaCash/gameBase.go   | 25 [32m+++++++++++[m[31m---[m
 themes/game/lavaCash/gameFree.go   | 57 [32m++++++++++++++++++++++++++[m[31m------[m
 themes/game/lavaCash/gameHelper.go |  7 [32m++[m[31m--[m
 themes/game/lavaCash/gameRespin.go |  4 [32m++[m[31m-[m
 7 files changed, 139 insertions(+), 50 deletions(-)
Switched to branch 'feature/jenkins'
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7001
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7001/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7001_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7001_dev_bandit
[0;35m           Network:[0m pk7001
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7001-redis:6379
[0;35m Backend-Container:[0m pk7001-backend
[1;33m  BANDIT-Container:[0m pk7001-rpc
[0;32m Fluentd-Container:[0m pk7001-fluentd
[0;32m   Mongo-Container:[0m pk7001-mongo
[0;32m   Redis-Container:[0m pk7001-redis
[1;33m            DATE:[0m 2023-03-29T17:42:47+0800
[1;33m   BUILD COMMAND:[0m cd bandit-server/cmd/server && go build -gcflags "-N -l" -ldflags '-X main.buildTime=2023-03-29T17:42:47+0800 -X main.buildCodeVer=bugfix/lavaCash_polish:dfd3687 -X main.buildConfVer=v1.1.16'
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m rpc-backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/bandit-server bugfix/lavaCash_polish:dfd3687
[1;33m        CONF_DIR:[0m /home/user00/cc/bandit-conf v1.1.16
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pk7001/config.ini
[1;33mCONFIG_FILE_PROD:[0m pk7001/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "rpc-backend-builder"   --hostname "rpc-backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/bandit-server":"/slots/bandit-server"   -v "/home/user00/cc/bandit-conf":"/slots/bandit-conf"   -v "/home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd bandit-server/cmd/server && go build -gcflags "-N -l" -ldflags '-X main.buildTime=2023-03-29T17:42:47+0800 -X main.buildCodeVer=bugfix/lavaCash_polish:dfd3687 -X main.buildConfVer=v1.1.16'"[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pk7001/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/cmd/server/server" "/home/user00/cc/cc-slots-land/stage/app=pk7001/app/bandit-server"[0m
[0;32mcopy theme collector data to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/themes/data" "/home/user00/cc/cc-slots-land/stage/app=pk7001/app/data"[0m
[0;32mremove container: rpc-backend-builder[0m
[0;36mreclaim resources: rpc-backend-builder af570ad29ff2[0m
af570ad29ff2
af570ad29ff2
[0;36mRPC_APP: pk7001-rpc[0m
[0;36mIMAGE: plutus:pk7001-rpc[0m
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  8.913MBSending build context to Docker daemon  16.71MBSending build context to Docker daemon  25.62MBSending build context to Docker daemon  33.98MBSending build context to Docker daemon  42.34MBSending build context to Docker daemon  50.69MBSending build context to Docker daemon  57.93MBSending build context to Docker daemon  65.73MBSending build context to Docker daemon  72.42MBSending build context to Docker daemon  79.66MBSending build context to Docker daemon  84.67MBSending build context to Docker daemon  90.24MBSending build context to Docker daemon  96.93MBSending build context to Docker daemon  105.3MBSending build context to Docker daemon  114.2MBSending build context to Docker daemon  122.6MBSending build context to Docker daemon  130.9MBSending build context to Docker daemon  138.7MBSending build context to Docker daemon  147.1MBSending build context to Docker daemon  155.4MBSending build context to Docker daemon  163.2MBSending build context to Docker daemon    171MBSending build context to Docker daemon  178.3MBSending build context to Docker daemon  185.5MBSending build context to Docker daemon  192.7MBSending build context to Docker daemon  196.1MBSending build context to Docker daemon  202.2MBSending build context to Docker daemon  208.9MBSending build context to Docker daemon  215.6MBSending build context to Docker daemon  222.3MBSending build context to Docker daemon  228.4MBSending build context to Docker daemon  232.8MBSending build context to Docker daemon  241.2MBSending build context to Docker daemon  250.1MBSending build context to Docker daemon  257.9MBSending build context to Docker daemon  265.7MBSending build context to Docker daemon  273.5MBSending build context to Docker daemon  281.3MBSending build context to Docker daemon  289.1MBSending build context to Docker daemon  295.8MBSending build context to Docker daemon  296.1MB
Step 1/7 : FROM golang:1.17-alpine
 ---> 270c4f58750f
Step 2/7 : RUN CGO_ENABLED=0 go install -ldflags "-s -w -extldflags '-static'" github.com/go-delve/delve/cmd/dlv@v1.7.3
 ---> Running in a694755f2129
[91mgo: downloading github.com/go-delve/delve v1.7.3
[0m[91mgo: downloading github.com/sirupsen/logrus v1.6.0
go: downloading github.com/spf13/cobra v1.1.3
[0m[91mgo: downloading github.com/mattn/go-isatty v0.0.3
[0m[91mgo: downloading gopkg.in/yaml.v2 v2.4.0
[0m[91mgo: downloading github.com/google/go-dap v0.6.0
[0m[91mgo: downloading golang.org/x/sys v0.0.0-20211019181941-9d821ace8654
[0m[91mgo: downloading github.com/cosiner/argv v0.1.0
[0m[91mgo: downloading github.com/derekparker/trie v0.0.0-20200317170641-1fdf38b7b0e9
[0m[91mgo: downloading github.com/peterh/liner v1.2.1
[0m[91mgo: downloading github.com/cpuguy83/go-md2man/v2 v2.0.0
[0m[91mgo: downloading github.com/spf13/pflag v1.0.5
[0m[91mgo: downloading github.com/hashicorp/golang-lru v0.5.4
[0m[91mgo: downloading golang.org/x/arch v0.0.0-20190927153633-4e8777c89be4
[0m[91mgo: downloading go.starlark.net v0.0.0-20200821142938-949cc6f4b097
[0m[91mgo: downloading github.com/russross/blackfriday/v2 v2.0.1
[0m[91mgo: downloading github.com/mattn/go-runewidth v0.0.3
[0m[91mgo: downloading github.com/cilium/ebpf v0.7.0
[0m[91mgo: downloading github.com/shurcooL/sanitized_anchor_name v1.0.0
[0mRemoving intermediate container a694755f2129
 ---> a720935ec776
Step 3/7 : RUN apk update 	&& apk add tzdata     && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime     && echo "Asia/Shanghai" >  /etc/timezone 	&& echo 'alias l="ls -ltA"' >> ~/.bashrc
 ---> Running in 265220fb0b99
fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/main/x86_64/APKINDEX.tar.gz
fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/community/x86_64/APKINDEX.tar.gz
v3.16.4-103-gdcd13fb2ac2 [https://dl-cdn.alpinelinux.org/alpine/v3.16/main]
v3.16.4-95-g1a38817769a [https://dl-cdn.alpinelinux.org/alpine/v3.16/community]
OK: 17048 distinct packages available
(1/1) Installing tzdata (2023c-r0)
Executing busybox-1.35.0-r15.trigger
OK: 9 MiB in 16 packages
Removing intermediate container 265220fb0b99
 ---> 523dcc2a5749
Step 4/7 : ARG app
 ---> Running in af42d8208801
Removing intermediate container af42d8208801
 ---> 7a8898187972
Step 5/7 : ADD $app/app/ /slots
 ---> d0c1de2f83ca
Step 6/7 : WORKDIR /slots
 ---> Running in f4c39f6eb297
Removing intermediate container f4c39f6eb297
 ---> 2c3a32e56d43
Step 7/7 : ENTRYPOINT ["/go/bin/dlv", "--listen=:4000", "--headless=true", "--log=true", "--accept-multiclient", "--api-version=2", "--check-go-version=false", "exec", "/slots/bandit-server"]
 ---> Running in 9afe4add3fbc
Removing intermediate container 9afe4add3fbc
 ---> fa7767332110
Successfully built fa7767332110
Successfully tagged plutus:pk7001-rpc
[0;32mgc: app=pk7001/app/rpc[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7001
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7001/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7001_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7001_dev_bandit
[0;35m           Network:[0m pk7001
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7001-redis:6379
[0;35m Backend-Container:[0m pk7001-backend
[1;33m  BANDIT-Container:[0m pk7001-rpc
[0;32m Fluentd-Container:[0m pk7001-fluentd
[0;32m   Mongo-Container:[0m pk7001-mongo
[0;32m   Redis-Container:[0m pk7001-redis

[0;32mstart pk7001-rpc[0m
[0;36m  docker run -d     -e app=pk7001.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pk7001     -e sys_stage=dev_bandit     -e hostname=10.0.84.16     -e TZ=Asia/Shanghai     -e log_server_host=pk7001-fluentd     -e log_server_port=24224     -e redis_uri=pk7001-redis:6379     -e redis_passwd=     -e redis_db=0     -v /home/user00/cc/bandit-server/configs:/slots/configs/     -e panel_storage=/slots/data/gen/rawdata/panel_storage     -p 5999:4000     --network pk7001     --name pk7001-rpc     --security-opt="apparmor=unconfined" --cap-add=SYS_PTRACE     plutus:pk7001-rpc[0m
[0;36mreclaim resources: pk7001-rpc 3576b9fce45f[0m
3576b9fce45f
3576b9fce45f
72c1e91a90138734cfbc7d45a8c7b5240eacb009d64504d37ec60721ddc3b543
API server listening at: [::]:4000
2023-03-29T17:45:25+08:00 warning layer=rpc Listening for remote connections (connections are not authenticated nor encrypted)
2023-03-29T17:45:25+08:00 info layer=debugger launching process with args: [/slots/bandit-server]
./run_image_rpc_gdb.sh: line 47: jq: command not found
2023-03-29T17:45:25+08:00 warning layer=rpc Listening for remote connections (connections are not authenticated nor encrypted)
2023-03-29T17:45:25+08:00 info layer=debugger launching process with args: [/slots/bandit-server]
Switched to branch 'master'
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pk7001"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E8%B0%83%E8%AF%95%E5%90%AF%E5%8A%A8RPC-Server/29/"

check_container() {
    exist=`docker inspect --format '{{.State.Running}}' $1`
    if [[ $exist == `false` ]];then
        echo $1" not OK"
        curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "link","link": {"messageUrl": "'"${BUILD_URL}"'/console","title": "Jenkins-RPC['"${server_name}"']-Failed","text": "check log for more detail"}}'
        exit 1
    else
        echo $1" Check"
    fi
}

check_whole_server() {
	check_container $1-backend
	check_container $1-rpc
	check_container $1-redis
	check_container $1-mongo
	check_container $1-fluentd
}
sleep 5
check_whole_server $server_name
curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "text","text": {"content": "Jenkins-RPC-Server['"${server_name}"'] Restart OK"}}'
pk7001-backend Check
pk7001-rpc Check
pk7001-redis Check
pk7001-mongo Check
pk7001-fluentd Check
{"errcode":0,"errmsg":"ok"}
[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
