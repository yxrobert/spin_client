Started by user [8mha:////4NL15lwhNok46o8LpNIYOqAIaurwr6Vm2yW5YSW4R5+wAAAAlh+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAyWEgYu/dLi1CL9ovz8EgDKVWzSvwAAAA==[0mroot
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 调试启动RPC-Server
[8mha:////4IgMzT7SzWWo7w4eh5cSEVfRM/d9DaB/jDT4I82Y+I0uAAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGldQkM+M0S9NE3cRkUzNdk+SUJN2kxBQzXfO0RANDs+SU1DRzEwCut6E5rwAAAA==[0m[SSH] executing pre build script:
server_name="pk7001"

#!/bin/bash 
source /root/jenkins/jk_func.sh

file_lock

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['bandit']")
rpc_port=$(yaml $conf_file "['$server_name']['rpc_port']")

cd /mnt/slots/bandit-server
git cd $branch_name
check_last_cmd branch

git pull
check_last_cmd pull

cd /mnt/slots/cc-slots-land/batch
git checkout feature/jenkins

./compile_rpc_gdb.sh $server_name && ./build_image_rpc_gdb.sh $server_name && ./run_image_rpc_gdb.sh $server_name $rpc_port

cd /mnt/slots/cc-slots-land/batch
git checkout master
file_unlock
脚本可执行
{'bandit': 'feature/lavaCash', 'game': 'feature/lavaCash', 'cc-conf': 'deploy-cc-conf', 'desc': 'pk7001', 'rpc_port': 7011, 'bandit-conf': 'deploy-bandit-conf', 'port': 7001}
Already on 'feature/lavaCash'
remote: Enumerating objects: 5, done.[K
remote: Counting objects:  20% (1/5)[Kremote: Counting objects:  40% (2/5)[Kremote: Counting objects:  60% (3/5)[Kremote: Counting objects:  80% (4/5)[Kremote: Counting objects: 100% (5/5)[Kremote: Counting objects: 100% (5/5), done.[K
remote: Compressing objects:  20% (1/5)[Kremote: Compressing objects:  40% (2/5)[Kremote: Compressing objects:  60% (3/5)[Kremote: Compressing objects:  80% (4/5)[Kremote: Compressing objects: 100% (5/5)[Kremote: Compressing objects: 100% (5/5), done.[K
remote: Total 5 (delta 0), reused 0 (delta 0), pack-reused 0[K
Unpacking objects:  20% (1/5)   Unpacking objects:  40% (2/5)   Unpacking objects:  60% (3/5)   Unpacking objects:  80% (4/5)   Unpacking objects: 100% (5/5)   Unpacking objects: 100% (5/5), done.
From gitlab.funplus.io:fruities/bandit-server
   d39bce7..e7e057b  feature/lavaCash -> origin/feature/lavaCash
Updating d39bce7..e7e057b
Fast-forward
 app/slots/MathGames.go | 11 [32m++++++[m[31m-----[m
 1 file changed, 6 insertions(+), 5 deletions(-)
Switched to branch 'feature/jenkins'
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7001
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7001/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7001_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7001_dev_bandit
[0;35m           Network:[0m pk7001
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7001-redis:6379
[0;35m Backend-Container:[0m pk7001-backend
[1;33m  BANDIT-Container:[0m pk7001-rpc
[0;32m Fluentd-Container:[0m pk7001-fluentd
[0;32m   Mongo-Container:[0m pk7001-mongo
[0;32m   Redis-Container:[0m pk7001-redis
[1;33m            DATE:[0m 2023-03-24T16:16:18+0800
[1;33m   BUILD COMMAND:[0m cd bandit-server/cmd/server && go build -gcflags "-N -l" -ldflags '-X main.buildTime=2023-03-24T16:16:18+0800 -X main.buildCodeVer=feature/lavaCash:e7e057b -X main.buildConfVer=v1.1.16'
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m rpc-backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/bandit-server feature/lavaCash:e7e057b
[1;33m        CONF_DIR:[0m /home/user00/cc/bandit-conf v1.1.16
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pk7001/config.ini
[1;33mCONFIG_FILE_PROD:[0m pk7001/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mreclaim resources: rpc-backend-builder d278ab5dd1e9[0m
d278ab5dd1e9
d278ab5dd1e9
[0;36mdocker run -it   --name "rpc-backend-builder"   --hostname "rpc-backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/bandit-server":"/slots/bandit-server"   -v "/home/user00/cc/bandit-conf":"/slots/bandit-conf"   -v "/home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd bandit-server/cmd/server && go build -gcflags "-N -l" -ldflags '-X main.buildTime=2023-03-24T16:16:18+0800 -X main.buildCodeVer=feature/lavaCash:e7e057b -X main.buildConfVer=v1.1.16'"[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pk7001/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/cmd/server/server" "/home/user00/cc/cc-slots-land/stage/app=pk7001/app/bandit-server"[0m
[0;32mcopy theme collector data to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/themes/data" "/home/user00/cc/cc-slots-land/stage/app=pk7001/app/data"[0m
[0;32mremove container: rpc-backend-builder[0m
[0;36mreclaim resources: rpc-backend-builder 755e5bbf15fd[0m
755e5bbf15fd
755e5bbf15fd
[0;36mRPC_APP: pk7001-rpc[0m
[0;36mIMAGE: plutus:pk7001-rpc[0m
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  8.356MBSending build context to Docker daemon  16.71MBSending build context to Docker daemon  24.51MBSending build context to Docker daemon  32.31MBSending build context to Docker daemon  40.11MBSending build context to Docker daemon  45.68MBSending build context to Docker daemon  53.48MBSending build context to Docker daemon  61.28MBSending build context to Docker daemon  69.07MBSending build context to Docker daemon  76.87MBSending build context to Docker daemon  83.56MBSending build context to Docker daemon  90.24MBSending build context to Docker daemon  99.16MBSending build context to Docker daemon  107.5MBSending build context to Docker daemon  115.3MBSending build context to Docker daemon  123.7MBSending build context to Docker daemon  131.5MBSending build context to Docker daemon    137MBSending build context to Docker daemon  143.7MBSending build context to Docker daemon  150.4MBSending build context to Docker daemon  157.1MBSending build context to Docker daemon  163.8MBSending build context to Docker daemon  171.6MBSending build context to Docker daemon  178.8MBSending build context to Docker daemon  185.5MBSending build context to Docker daemon  193.3MBSending build context to Docker daemon  199.4MBSending build context to Docker daemon  206.1MBSending build context to Docker daemon  212.8MBSending build context to Docker daemon    220MBSending build context to Docker daemon  227.8MBSending build context to Docker daemon  236.2MBSending build context to Docker daemon  245.1MBSending build context to Docker daemon  253.5MBSending build context to Docker daemon  262.4MBSending build context to Docker daemon  270.7MBSending build context to Docker daemon  278.5MBSending build context to Docker daemon  286.9MBSending build context to Docker daemon  294.7MBSending build context to Docker daemon    296MB
Step 1/7 : FROM golang:1.17-alpine
 ---> 270c4f58750f
Step 2/7 : RUN CGO_ENABLED=0 go install -ldflags "-s -w -extldflags '-static'" github.com/go-delve/delve/cmd/dlv@v1.7.3
 ---> Running in e66a4ad048b4
[91mgo: downloading github.com/go-delve/delve v1.7.3
[0m[91mgo: downloading github.com/sirupsen/logrus v1.6.0
go: downloading github.com/spf13/cobra v1.1.3
go: downloading github.com/mattn/go-isatty v0.0.3
[0m[91mgo: downloading gopkg.in/yaml.v2 v2.4.0
[0m[91mgo: downloading github.com/cosiner/argv v0.1.0
go: downloading github.com/derekparker/trie v0.0.0-20200317170641-1fdf38b7b0e9
[0m[91mgo: downloading github.com/peterh/liner v1.2.1
[0m[91mgo: downloading golang.org/x/sys v0.0.0-20211019181941-9d821ace8654
[0m[91mgo: downloading github.com/google/go-dap v0.6.0
[0m[91mgo: downloading github.com/hashicorp/golang-lru v0.5.4
[0m[91mgo: downloading golang.org/x/arch v0.0.0-20190927153633-4e8777c89be4
[0m[91mgo: downloading go.starlark.net v0.0.0-20200821142938-949cc6f4b097
[0m[91mgo: downloading github.com/cpuguy83/go-md2man/v2 v2.0.0
[0m[91mgo: downloading github.com/spf13/pflag v1.0.5
[0m[91mgo: downloading github.com/cilium/ebpf v0.7.0
[0m[91mgo: downloading github.com/mattn/go-runewidth v0.0.3
go: downloading github.com/russross/blackfriday/v2 v2.0.1
[0m[91mgo: downloading github.com/shurcooL/sanitized_anchor_name v1.0.0
[0mRemoving intermediate container e66a4ad048b4
 ---> d4b26677eab5
Step 3/7 : RUN apk update 	&& apk add tzdata     && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime     && echo "Asia/Shanghai" >  /etc/timezone 	&& echo 'alias l="ls -ltA"' >> ~/.bashrc
 ---> Running in 47b6ee2b613a
fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/main/x86_64/APKINDEX.tar.gz
fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/community/x86_64/APKINDEX.tar.gz
v3.16.4-91-gc3416f87c43 [https://dl-cdn.alpinelinux.org/alpine/v3.16/main]
v3.16.4-91-gc3416f87c43 [https://dl-cdn.alpinelinux.org/alpine/v3.16/community]
OK: 17048 distinct packages available
(1/1) Installing tzdata (2022f-r1)
Executing busybox-1.35.0-r15.trigger
OK: 9 MiB in 16 packages
Removing intermediate container 47b6ee2b613a
 ---> d76e8f3711ae
Step 4/7 : ARG app
 ---> Running in f64dcad78596
Removing intermediate container f64dcad78596
 ---> e9cd7729708e
Step 5/7 : ADD $app/app/ /slots
 ---> 4a620a19517b
Step 6/7 : WORKDIR /slots
 ---> Running in c64a64188d1b
Removing intermediate container c64a64188d1b
 ---> 1010e8d71128
Step 7/7 : ENTRYPOINT ["/go/bin/dlv", "--listen=:4000", "--headless=true", "--log=true", "--accept-multiclient", "--api-version=2", "--check-go-version=false", "exec", "/slots/bandit-server"]
 ---> Running in 5815ce51db04
Removing intermediate container 5815ce51db04
 ---> 4ba28e09e920
Successfully built 4ba28e09e920
Successfully tagged plutus:pk7001-rpc
[0;32mgc: app=pk7001/app/rpc[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pk7001
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pk7001/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pk7001/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pk7001_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pk7001_dev_bandit
[0;35m           Network:[0m pk7001
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pk7001-redis:6379
[0;35m Backend-Container:[0m pk7001-backend
[1;33m  BANDIT-Container:[0m pk7001-rpc
[0;32m Fluentd-Container:[0m pk7001-fluentd
[0;32m   Mongo-Container:[0m pk7001-mongo
[0;32m   Redis-Container:[0m pk7001-redis

[0;32mstart pk7001-rpc[0m
[0;36m  docker run -d     -e app=pk7001.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pk7001     -e sys_stage=dev_bandit     -e hostname=10.0.84.16     -e TZ=Asia/Shanghai     -e log_server_host=pk7001-fluentd     -e log_server_port=24224     -e redis_uri=pk7001-redis:6379     -e redis_passwd=     -e redis_db=0     -v /home/user00/cc/bandit-server/configs:/slots/configs/     -e panel_storage=/slots/data/gen/rawdata/panel_storage     -p 5999:4000     --network pk7001     --name pk7001-rpc     --security-opt="apparmor=unconfined" --cap-add=SYS_PTRACE     plutus:pk7001-rpc[0m
[0;36mreclaim resources: pk7001-rpc d51faf7dcf44[0m
d51faf7dcf44
d51faf7dcf44
cb61c299d69300e91bb58e18e4ea074b0edd099878fe8011fabf67631b3b39c9
2023-03-24T16:18:58+08:00 warning layer=rpc Listening for remote connections (connections are not authenticated nor encrypted)
API server listening at: [::]:4000
2023-03-24T16:18:58+08:00 info layer=debugger launching process with args: [/slots/bandit-server]
./run_image_rpc_gdb.sh: line 47: jq: command not found
2023-03-24T16:18:58+08:00 warning layer=rpc Listening for remote connections (connections are not authenticated nor encrypted)
2023-03-24T16:18:58+08:00 info layer=debugger launching process with args: [/slots/bandit-server]
Switched to branch 'master'
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pk7001"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E8%B0%83%E8%AF%95%E5%90%AF%E5%8A%A8RPC-Server/26/"

check_container() {
    exist=`docker inspect --format '{{.State.Running}}' $1`
    if [[ $exist == `false` ]];then
        echo $1" not OK"
        curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "link","link": {"messageUrl": "'"${BUILD_URL}"'/console","title": "Jenkins-RPC['"${server_name}"']-Failed","text": "check log for more detail"}}'
        exit 1
    else
        echo $1" Check"
    fi
}

check_whole_server() {
	check_container $1-backend
	check_container $1-rpc
	check_container $1-redis
	check_container $1-mongo
	check_container $1-fluentd
}
sleep 5
check_whole_server $server_name
curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "text","text": {"content": "Jenkins-RPC-Server['"${server_name}"'] Restart OK"}}'
pk7001-backend Check
pk7001-rpc Check
pk7001-redis Check
pk7001-mongo Check
pk7001-fluentd Check
{"errcode":0,"errmsg":"ok"}
[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
