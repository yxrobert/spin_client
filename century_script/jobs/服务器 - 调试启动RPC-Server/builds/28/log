Started by user [8mha:////4NL15lwhNok46o8LpNIYOqAIaurwr6Vm2yW5YSW4R5+wAAAAlh+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAyWEgYu/dLi1CL9ovz8EgDKVWzSvwAAAA==[0mroot
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 调试启动RPC-Server
[8mha:////4JE1I472LkHXExLPZDsc3d/Ez0iRQ56K2FvHRkyx5QvwAAAAqx+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGFQMTC3MDUyMD3UTTxCRdEzMLY93E5FQD3TSz1ESj5DRLE0PDJABbBsLWrwAAAA==[0m[SSH] executing pre build script:
server_name="pkcp"

#!/bin/bash 
source /root/jenkins/jk_func.sh

file_lock

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['bandit']")
rpc_port=$(yaml $conf_file "['$server_name']['rpc_port']")

cd /mnt/slots/bandit-server
git cd $branch_name
check_last_cmd branch

git pull
check_last_cmd pull

cd /mnt/slots/cc-slots-land/batch
git checkout feature/jenkins

./compile_rpc_gdb.sh $server_name && ./build_image_rpc_gdb.sh $server_name && ./run_image_rpc_gdb.sh $server_name $rpc_port

cd /mnt/slots/cc-slots-land/batch
git checkout master
file_unlock
脚本可执行
{'bandit': 'develop', 'game': 'feature/spin_max_bonus', 'cc-conf': 'deploy-cc-conf', 'desc': 'pkcp', 'rpc_port': 10009, 'bandit-conf': 'deploy-bandit-conf', 'port': 9999}
Already on 'develop'
Already up-to-date.
Switched to branch 'feature/jenkins'
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkcp
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkcp/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkcp_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkcp_dev_bandit
[0;35m           Network:[0m pkcp
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkcp-redis:6379
[0;35m Backend-Container:[0m pkcp-backend
[1;33m  BANDIT-Container:[0m pkcp-rpc
[0;32m Fluentd-Container:[0m pkcp-fluentd
[0;32m   Mongo-Container:[0m pkcp-mongo
[0;32m   Redis-Container:[0m pkcp-redis
[1;33m            DATE:[0m 2023-03-27T14:09:13+0800
[1;33m   BUILD COMMAND:[0m cd bandit-server/cmd/server && go build -gcflags "-N -l" -ldflags '-X main.buildTime=2023-03-27T14:09:13+0800 -X main.buildCodeVer=develop:bafefac -X main.buildConfVer=v1.1.16'
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m rpc-backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/bandit-server develop:bafefac
[1;33m        CONF_DIR:[0m /home/user00/cc/bandit-conf v1.1.16
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pkcp/config.ini
[1;33mCONFIG_FILE_PROD:[0m pkcp/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "rpc-backend-builder"   --hostname "rpc-backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/bandit-server":"/slots/bandit-server"   -v "/home/user00/cc/bandit-conf":"/slots/bandit-conf"   -v "/home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd bandit-server/cmd/server && go build -gcflags "-N -l" -ldflags '-X main.buildTime=2023-03-27T14:09:13+0800 -X main.buildCodeVer=develop:bafefac -X main.buildConfVer=v1.1.16'"[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pkcp/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/cmd/server/server" "/home/user00/cc/cc-slots-land/stage/app=pkcp/app/bandit-server"[0m
[0;32mcopy theme collector data to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/themes/data" "/home/user00/cc/cc-slots-land/stage/app=pkcp/app/data"[0m
[0;32mremove container: rpc-backend-builder[0m
[0;36mreclaim resources: rpc-backend-builder 03ad2c5ae01c[0m
03ad2c5ae01c
03ad2c5ae01c
[0;36mRPC_APP: pkcp-rpc[0m
[0;36mIMAGE: plutus:pkcp-rpc[0m
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  8.356MBSending build context to Docker daemon  16.71MBSending build context to Docker daemon  23.95MBSending build context to Docker daemon  32.87MBSending build context to Docker daemon  41.78MBSending build context to Docker daemon  49.58MBSending build context to Docker daemon  57.93MBSending build context to Docker daemon   63.5MBSending build context to Docker daemon   71.3MBSending build context to Docker daemon   79.1MBSending build context to Docker daemon  86.34MBSending build context to Docker daemon  93.59MBSending build context to Docker daemon  101.4MBSending build context to Docker daemon  108.1MBSending build context to Docker daemon  116.4MBSending build context to Docker daemon  125.3MBSending build context to Docker daemon  133.7MBSending build context to Docker daemon  140.4MBSending build context to Docker daemon  148.7MBSending build context to Docker daemon  157.1MBSending build context to Docker daemon  164.3MBSending build context to Docker daemon  171.6MBSending build context to Docker daemon  177.1MBSending build context to Docker daemon    181MBSending build context to Docker daemon  187.2MBSending build context to Docker daemon  191.6MBSending build context to Docker daemon  197.8MBSending build context to Docker daemon  204.4MBSending build context to Docker daemon  212.2MBSending build context to Docker daemon    220MBSending build context to Docker daemon  227.3MBSending build context to Docker daemon  235.1MBSending build context to Docker daemon  242.3MBSending build context to Docker daemon  250.1MBSending build context to Docker daemon  257.4MBSending build context to Docker daemon    264MBSending build context to Docker daemon  271.3MBSending build context to Docker daemon  279.6MBSending build context to Docker daemon    288MBSending build context to Docker daemon  295.8MBSending build context to Docker daemon  296.1MB
Step 1/7 : FROM golang:1.17-alpine
 ---> 270c4f58750f
Step 2/7 : RUN CGO_ENABLED=0 go install -ldflags "-s -w -extldflags '-static'" github.com/go-delve/delve/cmd/dlv@v1.7.3
 ---> Running in 5536009b0262
[91mgo: downloading github.com/go-delve/delve v1.7.3
[0m[91mgo: downloading github.com/sirupsen/logrus v1.6.0
[0m[91mgo: downloading github.com/spf13/cobra v1.1.3
[0m[91mgo: downloading github.com/mattn/go-isatty v0.0.3
[0m[91mgo: downloading gopkg.in/yaml.v2 v2.4.0
[0m[91mgo: downloading github.com/cosiner/argv v0.1.0
[0m[91mgo: downloading github.com/derekparker/trie v0.0.0-20200317170641-1fdf38b7b0e9
[0m[91mgo: downloading github.com/peterh/liner v1.2.1
[0m[91mgo: downloading github.com/google/go-dap v0.6.0
[0m[91mgo: downloading golang.org/x/sys v0.0.0-20211019181941-9d821ace8654
[0m[91mgo: downloading go.starlark.net v0.0.0-20200821142938-949cc6f4b097
[0m[91mgo: downloading github.com/cpuguy83/go-md2man/v2 v2.0.0
[0m[91mgo: downloading github.com/spf13/pflag v1.0.5
[0m[91mgo: downloading github.com/hashicorp/golang-lru v0.5.4
[0m[91mgo: downloading golang.org/x/arch v0.0.0-20190927153633-4e8777c89be4
[0m[91mgo: downloading github.com/mattn/go-runewidth v0.0.3
[0m[91mgo: downloading github.com/cilium/ebpf v0.7.0
[0m[91mgo: downloading github.com/russross/blackfriday/v2 v2.0.1
[0m[91mgo: downloading github.com/shurcooL/sanitized_anchor_name v1.0.0
[0mRemoving intermediate container 5536009b0262
 ---> 633a92c9a479
Step 3/7 : RUN apk update 	&& apk add tzdata     && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime     && echo "Asia/Shanghai" >  /etc/timezone 	&& echo 'alias l="ls -ltA"' >> ~/.bashrc
 ---> Running in bd2523f400c9
fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/main/x86_64/APKINDEX.tar.gz
fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/community/x86_64/APKINDEX.tar.gz
v3.16.4-97-g4db65f4440d [https://dl-cdn.alpinelinux.org/alpine/v3.16/main]
v3.16.4-95-g1a38817769a [https://dl-cdn.alpinelinux.org/alpine/v3.16/community]
OK: 17048 distinct packages available
(1/1) Installing tzdata (2023b-r1)
Executing busybox-1.35.0-r15.trigger
OK: 9 MiB in 16 packages
Removing intermediate container bd2523f400c9
 ---> 52fd7ff1ace7
Step 4/7 : ARG app
 ---> Running in ad9ec1d5785d
Removing intermediate container ad9ec1d5785d
 ---> 65a69ad82cf8
Step 5/7 : ADD $app/app/ /slots
 ---> cf1ea91a520b
Step 6/7 : WORKDIR /slots
 ---> Running in 250d429fe580
Removing intermediate container 250d429fe580
 ---> 7e0b9dc4cd7e
Step 7/7 : ENTRYPOINT ["/go/bin/dlv", "--listen=:4000", "--headless=true", "--log=true", "--accept-multiclient", "--api-version=2", "--check-go-version=false", "exec", "/slots/bandit-server"]
 ---> Running in 859197aa900d
Removing intermediate container 859197aa900d
 ---> 106b7dfd5aa8
Successfully built 106b7dfd5aa8
Successfully tagged plutus:pkcp-rpc
[0;32mgc: app=pkcp/app/rpc[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkcp
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkcp/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkcp_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkcp_dev_bandit
[0;35m           Network:[0m pkcp
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkcp-redis:6379
[0;35m Backend-Container:[0m pkcp-backend
[1;33m  BANDIT-Container:[0m pkcp-rpc
[0;32m Fluentd-Container:[0m pkcp-fluentd
[0;32m   Mongo-Container:[0m pkcp-mongo
[0;32m   Redis-Container:[0m pkcp-redis

[0;32mstart pkcp-rpc[0m
[0;36m  docker run -d     -e app=pkcp.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pkcp     -e sys_stage=dev_bandit     -e hostname=10.0.84.16     -e TZ=Asia/Shanghai     -e log_server_host=pkcp-fluentd     -e log_server_port=24224     -e redis_uri=pkcp-redis:6379     -e redis_passwd=     -e redis_db=0     -v /home/user00/cc/bandit-server/configs:/slots/configs/     -e panel_storage=/slots/data/gen/rawdata/panel_storage     -p 5999:4000     --network pkcp     --name pkcp-rpc     --security-opt="apparmor=unconfined" --cap-add=SYS_PTRACE     plutus:pkcp-rpc[0m
[0;36mreclaim resources: pkcp-rpc b9f0bcd0e189[0m
b9f0bcd0e189
b9f0bcd0e189
ddd6fc98097c9667a9b221395fbe0f2a092711043b0822932917d2d1c272537e
2023-03-27T14:12:07+08:00 warning layer=rpc Listening for remote connections (connections are not authenticated nor encrypted)
2023-03-27T14:12:07+08:00 info layer=debugger launching process with args: [/slots/bandit-server]
API server listening at: [::]:4000
./run_image_rpc_gdb.sh: line 47: jq: command not found
2023-03-27T14:12:07+08:00 warning layer=rpc Listening for remote connections (connections are not authenticated nor encrypted)
2023-03-27T14:12:07+08:00 info layer=debugger launching process with args: [/slots/bandit-server]
Switched to branch 'master'
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pkcp"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E8%B0%83%E8%AF%95%E5%90%AF%E5%8A%A8RPC-Server/28/"

check_container() {
    exist=`docker inspect --format '{{.State.Running}}' $1`
    if [[ $exist == `false` ]];then
        echo $1" not OK"
        curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "link","link": {"messageUrl": "'"${BUILD_URL}"'/console","title": "Jenkins-RPC['"${server_name}"']-Failed","text": "check log for more detail"}}'
        exit 1
    else
        echo $1" Check"
    fi
}

check_whole_server() {
	check_container $1-backend
	check_container $1-rpc
	check_container $1-redis
	check_container $1-mongo
	check_container $1-fluentd
}
sleep 5
check_whole_server $server_name
curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "text","text": {"content": "Jenkins-RPC-Server['"${server_name}"'] Restart OK"}}'
pkcp-backend Check
pkcp-rpc Check
pkcp-redis Check
pkcp-mongo Check
pkcp-fluentd Check
{"errcode":0,"errmsg":"ok"}
[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
