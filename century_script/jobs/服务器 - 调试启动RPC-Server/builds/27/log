Started by user [8mha:////4NL15lwhNok46o8LpNIYOqAIaurwr6Vm2yW5YSW4R5+wAAAAlh+LCAAAAAAAAP9b85aBtbiIQTGjNKU4P08vOT+vOD8nVc83PyU1x6OyILUoJzMv2y+/JJUBAhiZGBgqihhk0NSjKDWzXb3RdlLBUSYGJk8GtpzUvPSSDB8G5tKinBIGIZ+sxLJE/ZzEvHT94JKizLx0a6BxUmjGOUNodHsLgAyWEgYu/dLi1CL9ovz8EgDKVWzSvwAAAA==[0mroot
Running as SYSTEM
[EnvInject] - Loading node environment variables.
Building in workspace /var/jenkins_home/workspace/服务器 - 调试启动RPC-Server
[8mha:////4NOrKuhh7WjvtHpT0SHFRM4IgzNURrh3d4kTxSy44/7YAAAAqR+LCAAAAAAAAP9b85aBtbiIQSujNKU4P0+vIKc0PTOvWC8xrzgzOT8nv0gvMbkkEyjhCKb88ktSdwVsu2efuqidiYHRh4EDIu2ZUsIg5JOVWJaon5OYl64fXFKUmZduXVHEIAU1ODk/rzg/J1XPGUKDDGKAAEYmBoaKghIGlRRz0xQTI3NDXePENEtdE6MUA90kU1MT3RQLoIxxMlAyyRQAQLOWj68AAAA=[0m[SSH] executing pre build script:
server_name="pkcp"

#!/bin/bash 
source /root/jenkins/jk_func.sh

file_lock

yaml $conf_file "['$server_name']"
branch_name=$(yaml $conf_file "['$server_name']['bandit']")
rpc_port=$(yaml $conf_file "['$server_name']['rpc_port']")

cd /mnt/slots/bandit-server
git cd $branch_name
check_last_cmd branch

git pull
check_last_cmd pull

cd /mnt/slots/cc-slots-land/batch
git checkout feature/jenkins

./compile_rpc_gdb.sh $server_name && ./build_image_rpc_gdb.sh $server_name && ./run_image_rpc_gdb.sh $server_name $rpc_port

cd /mnt/slots/cc-slots-land/batch
git checkout master
file_unlock
脚本可执行
{'bandit': 'develop', 'game': 'feature/spin_max_card_pr1', 'cc-conf': 'deploy-cc-conf', 'desc': 'pkcp', 'rpc_port': 10009, 'bandit-conf': 'deploy-bandit-conf', 'port': 9999}
Switched to branch 'develop'
Already up-to-date.
Switched to branch 'feature/jenkins'
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkcp
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkcp/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkcp_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkcp_dev_bandit
[0;35m           Network:[0m pkcp
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkcp-redis:6379
[0;35m Backend-Container:[0m pkcp-backend
[1;33m  BANDIT-Container:[0m pkcp-rpc
[0;32m Fluentd-Container:[0m pkcp-fluentd
[0;32m   Mongo-Container:[0m pkcp-mongo
[0;32m   Redis-Container:[0m pkcp-redis
[1;33m            DATE:[0m 2023-03-27T10:18:02+0800
[1;33m   BUILD COMMAND:[0m cd bandit-server/cmd/server && go build -gcflags "-N -l" -ldflags '-X main.buildTime=2023-03-27T10:18:02+0800 -X main.buildCodeVer=develop:8fb40de -X main.buildConfVer=v1.1.16'
[1;33m           IMAGE:[0m slots/backend-builder:latest
[1;33m       CONTAINER:[0m rpc-backend-builder
[1;33m          GO_DIR:[0m /home/user00/cc/cc-slots-land/go
[1;33m        CODE_DIR:[0m /home/user00/cc/bandit-server develop:8fb40de
[1;33m        CONF_DIR:[0m /home/user00/cc/bandit-conf v1.1.16
[1;33m       BUILD_DIR:[0m /slots
[1;33m  BUILD_CONF_DIR:[0m /cc-conf
[1;33m     CONFIG_FILE:[0m pkcp/config.ini
[1;33mCONFIG_FILE_PROD:[0m pkcp/config.ini
[0;32mMOUNT_CONF_LOADER => /home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf[0m
[0;32m MOUNT_CONF_MODEL => /home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata[0m
[0;36mdocker run -it   --name "rpc-backend-builder"   --hostname "rpc-backend-builder"   -v "/home/user00/cc/cc-slots-land/go":/go   -v "/home/user00/cc/bandit-server":"/slots/bandit-server"   -v "/home/user00/cc/bandit-conf":"/slots/bandit-conf"   -v "/home/user00/cc/bandit-conf/gen/golang/conf:/slots/server/pkg/gen/golang/conf"   -v "/home/user00/cc/bandit-conf/gen/golang/rawdata:/cc-conf/gen/golang/rawdata"    "slots/backend-builder:latest"   sh -c "cd bandit-server/cmd/server && go build -gcflags "-N -l" -ldflags '-X main.buildTime=2023-03-27T10:18:02+0800 -X main.buildCodeVer=develop:8fb40de -X main.buildConfVer=v1.1.16'"[0m
[0;32mreset app dir: /home/user00/cc/cc-slots-land/stage/app=pkcp/app[0m
[0;32mcopy compiled binary to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/cmd/server/server" "/home/user00/cc/cc-slots-land/stage/app=pkcp/app/bandit-server"[0m
[0;32mcopy theme collector data to app dir...[0m
[0;36mdocker container cp "rpc-backend-builder:/slots/bandit-server/themes/data" "/home/user00/cc/cc-slots-land/stage/app=pkcp/app/data"[0m
[0;32mremove container: rpc-backend-builder[0m
[0;36mreclaim resources: rpc-backend-builder 658ea0bbad1a[0m
658ea0bbad1a
658ea0bbad1a
[0;36mRPC_APP: pkcp-rpc[0m
[0;36mIMAGE: plutus:pkcp-rpc[0m
[0;32m/home/user00/cc/cc-slots-land/stage[0m
Sending build context to Docker daemon  557.1kBSending build context to Docker daemon  6.685MBSending build context to Docker daemon  12.81MBSending build context to Docker daemon   19.5MBSending build context to Docker daemon   27.3MBSending build context to Docker daemon  36.21MBSending build context to Docker daemon  44.56MBSending build context to Docker daemon  52.92MBSending build context to Docker daemon  60.72MBSending build context to Docker daemon  68.52MBSending build context to Docker daemon  76.32MBSending build context to Docker daemon  83.56MBSending build context to Docker daemon  91.91MBSending build context to Docker daemon  100.3MBSending build context to Docker daemon  109.2MBSending build context to Docker daemon  115.9MBSending build context to Docker daemon  123.7MBSending build context to Docker daemon  131.5MBSending build context to Docker daemon  137.6MBSending build context to Docker daemon  145.9MBSending build context to Docker daemon  154.3MBSending build context to Docker daemon  161.5MBSending build context to Docker daemon  169.3MBSending build context to Docker daemon  177.1MBSending build context to Docker daemon  184.4MBSending build context to Docker daemon  191.1MBSending build context to Docker daemon  197.2MBSending build context to Docker daemon  202.2MBSending build context to Docker daemon    210MBSending build context to Docker daemon  218.4MBSending build context to Docker daemon  225.6MBSending build context to Docker daemon  232.3MBSending build context to Docker daemon  235.6MBSending build context to Docker daemon  240.6MBSending build context to Docker daemon  246.8MBSending build context to Docker daemon    254MBSending build context to Docker daemon    259MBSending build context to Docker daemon  266.8MBSending build context to Docker daemon  275.2MBSending build context to Docker daemon  283.5MBSending build context to Docker daemon  291.3MBSending build context to Docker daemon  295.5MB
Step 1/7 : FROM golang:1.17-alpine
 ---> 270c4f58750f
Step 2/7 : RUN CGO_ENABLED=0 go install -ldflags "-s -w -extldflags '-static'" github.com/go-delve/delve/cmd/dlv@v1.7.3
 ---> Running in 0a8b370edf10
[91mgo: downloading github.com/go-delve/delve v1.7.3
[0m[91mgo: downloading github.com/sirupsen/logrus v1.6.0
go: downloading github.com/spf13/cobra v1.1.3
[0m[91mgo: downloading github.com/mattn/go-isatty v0.0.3
[0m[91mgo: downloading gopkg.in/yaml.v2 v2.4.0
[0m[91mgo: downloading golang.org/x/sys v0.0.0-20211019181941-9d821ace8654
[0m[91mgo: downloading github.com/cosiner/argv v0.1.0
[0m[91mgo: downloading github.com/derekparker/trie v0.0.0-20200317170641-1fdf38b7b0e9
[0m[91mgo: downloading github.com/peterh/liner v1.2.1
[0m[91mgo: downloading github.com/google/go-dap v0.6.0
[0m[91mgo: downloading github.com/cpuguy83/go-md2man/v2 v2.0.0
[0m[91mgo: downloading github.com/spf13/pflag v1.0.5
[0m[91mgo: downloading go.starlark.net v0.0.0-20200821142938-949cc6f4b097
[0m[91mgo: downloading github.com/hashicorp/golang-lru v0.5.4
go: downloading golang.org/x/arch v0.0.0-20190927153633-4e8777c89be4
[0m[91mgo: downloading github.com/mattn/go-runewidth v0.0.3
[0m[91mgo: downloading github.com/russross/blackfriday/v2 v2.0.1
[0m[91mgo: downloading github.com/cilium/ebpf v0.7.0
[0m[91mgo: downloading github.com/shurcooL/sanitized_anchor_name v1.0.0
[0mRemoving intermediate container 0a8b370edf10
 ---> e68de8156082
Step 3/7 : RUN apk update 	&& apk add tzdata     && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime     && echo "Asia/Shanghai" >  /etc/timezone 	&& echo 'alias l="ls -ltA"' >> ~/.bashrc
 ---> Running in 852fe3aafe80
fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/main/x86_64/APKINDEX.tar.gz
fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/community/x86_64/APKINDEX.tar.gz
v3.16.4-97-g4db65f4440d [https://dl-cdn.alpinelinux.org/alpine/v3.16/main]
v3.16.4-95-g1a38817769a [https://dl-cdn.alpinelinux.org/alpine/v3.16/community]
OK: 17048 distinct packages available
(1/1) Installing tzdata (2023b-r1)
Executing busybox-1.35.0-r15.trigger
OK: 9 MiB in 16 packages
Removing intermediate container 852fe3aafe80
 ---> d244a788eedb
Step 4/7 : ARG app
 ---> Running in 9b4a3f3bf2b8
Removing intermediate container 9b4a3f3bf2b8
 ---> 07f69d2e9c7b
Step 5/7 : ADD $app/app/ /slots
 ---> b9c7c452129d
Step 6/7 : WORKDIR /slots
 ---> Running in b3131ec52391
Removing intermediate container b3131ec52391
 ---> b14f13d68774
Step 7/7 : ENTRYPOINT ["/go/bin/dlv", "--listen=:4000", "--headless=true", "--log=true", "--accept-multiclient", "--api-version=2", "--check-go-version=false", "exec", "/slots/bandit-server"]
 ---> Running in 7e9af42d29cf
Removing intermediate container 7e9af42d29cf
 ---> a5c8acfd12e1
Successfully built a5c8acfd12e1
Successfully tagged plutus:pkcp-rpc
[0;32mgc: app=pkcp/app/rpc[0m
/mnt/slots/cc-slots-land/batch
[0;35m              ARCH:[0m linux
[0;35m          LOCAL_IP:[0m 10.0.84.16
[0;35m               APP:[0m pkcp
[0;32m           APP_DIR:[0m /home/user00/cc/cc-slots-land/stage/app=pkcp/app
[0;32m       Fluentd-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/fluentd
[0;32m         Mongo-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/mongo
[0;32m         Redis-DIR:[0m /mnt/slots/cc-slots-land/batch/pkcp/redis
[0;32m       PM_CONF_DIR:[0m /home/user00/cc/cc-conf/gen/rawdata/server
[0;35m  BACKEND_CODE_DIR:[0m /home/user00/cc/cc-server
[0;35m  BACKEND_CONF_DIR:[0m /home/user00/cc/cc-conf
[1;33m   BANDIT_CODE_DIR:[0m /home/user00/cc/bandit-server
[1;33m   BANDIT_CONF_DIR:[0m /home/user00/cc/bandit-conf
[0;35m   BACKEND_PM_PATH:[0m /pkcp_dev_backend
[1;33m    BANDIT_PM_PATH:[0m /pkcp_dev_bandit
[0;35m           Network:[0m pkcp
[0;35m    ETCD_ENDPOINTS:[0m 10.0.84.16:2379
[0;35m         REDIS_URI:[0m pkcp-redis:6379
[0;35m Backend-Container:[0m pkcp-backend
[1;33m  BANDIT-Container:[0m pkcp-rpc
[0;32m Fluentd-Container:[0m pkcp-fluentd
[0;32m   Mongo-Container:[0m pkcp-mongo
[0;32m   Redis-Container:[0m pkcp-redis

[0;32mstart pkcp-rpc[0m
[0;36m  docker run -d     -e app=pkcp.dev     -e etcd_endpoints=10.0.84.16:2379     -e sys_env_name=pkcp     -e sys_stage=dev_bandit     -e hostname=10.0.84.16     -e TZ=Asia/Shanghai     -e log_server_host=pkcp-fluentd     -e log_server_port=24224     -e redis_uri=pkcp-redis:6379     -e redis_passwd=     -e redis_db=0     -v /home/user00/cc/bandit-server/configs:/slots/configs/     -e panel_storage=/slots/data/gen/rawdata/panel_storage     -p 5999:4000     --network pkcp     --name pkcp-rpc     --security-opt="apparmor=unconfined" --cap-add=SYS_PTRACE     plutus:pkcp-rpc[0m
[0;36mreclaim resources: pkcp-rpc c217e43ce38b[0m
c217e43ce38b
c217e43ce38b
1161bdcb063a8359ddf925250f2419c11dc1c06032c0b69f7fa967fe2632b3a9
2023-03-27T10:20:43+08:00 warning layer=rpc Listening for remote connections (connections are not authenticated nor encrypted)
2023-03-27T10:20:43+08:00 info layer=debugger launching process with args: [/slots/bandit-server]
API server listening at: [::]:4000
./run_image_rpc_gdb.sh: line 47: jq: command not found
2023-03-27T10:20:43+08:00 warning layer=rpc Listening for remote connections (connections are not authenticated nor encrypted)
2023-03-27T10:20:43+08:00 info layer=debugger launching process with args: [/slots/bandit-server]
Switched to branch 'master'
释放脚本锁

[SSH] completed
[SSH] exit-status: 0

[SSH] executing post build script:
server_name="pkcp"
BUILD_URL="http://10.0.84.16:8083/job/%E6%9C%8D%E5%8A%A1%E5%99%A8%20-%20%E8%B0%83%E8%AF%95%E5%90%AF%E5%8A%A8RPC-Server/27/"

check_container() {
    exist=`docker inspect --format '{{.State.Running}}' $1`
    if [[ $exist == `false` ]];then
        echo $1" not OK"
        curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "link","link": {"messageUrl": "'"${BUILD_URL}"'/console","title": "Jenkins-RPC['"${server_name}"']-Failed","text": "check log for more detail"}}'
        exit 1
    else
        echo $1" Check"
    fi
}

check_whole_server() {
	check_container $1-backend
	check_container $1-rpc
	check_container $1-redis
	check_container $1-mongo
	check_container $1-fluentd
}
sleep 5
check_whole_server $server_name
curl 'https://oapi.dingtalk.com/robot/send?access_token=13aa551ba8a79265c4424316089cd31c4f479b0f685f3d5a503b0ab6a1a42ec7' -H 'Content-Type: application/json'  -d '{"msgtype": "text","text": {"content": "Jenkins-RPC-Server['"${server_name}"'] Restart OK"}}'
pkcp-backend Check
pkcp-rpc Check
pkcp-redis Check
pkcp-mongo Check
pkcp-fluentd Check
{"errcode":0,"errmsg":"ok"}
[SSH] completed
[SSH] exit-status: 0

Finished: SUCCESS
